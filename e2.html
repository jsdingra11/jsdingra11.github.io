<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Space Day Quiz 2025 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Tahoma', sans-serif;
            background-image: url('https://specials-images.forbesimg.com/imageserve/6683c1640eb9ff99522c17f0/Misty-Mountains/960x0.jpg?fit=scale'); /* Starry space background */
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }
        .win-xp-container {
            background-color: #ECE9D8;
            border: 2px solid #003399;
            border-radius: 8px;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }
        .win-xp-title-bar {
            background: linear-gradient(to right, #0058e5, #3a8cff);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        .win-xp-button {
            background-color: #f0f0f0;
            border: 1px solid #707070;
            border-radius: 3px;
            box-shadow: inset -1px -1px 0px #a0a0a0, inset 1px 1px 0px #ffffff;
            font-weight: normal;
        }
        .win-xp-button:active {
            box-shadow: inset 1px 1px 0px #a0a0a0, inset -1px -1px 0px #ffffff;
        }
        .win-xp-input {
            border: 1px solid #7f9db9;
            background-color: white;
        }
        .loader {
            border: 4px solid #f0f0f0;
            border-top: 4px solid #0058e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    
    <!-- Big Corner countdown timer display -->
    <div id="corner-countdown" class="hidden absolute top-5 right-5 bg-white text-red-600 p-4 rounded-full shadow-2xl text-4xl font-bold border-4 border-red-200 w-24 h-24 flex items-center justify-center win-xp-container"></div>

    <div id="app" class="win-xp-container w-full max-w-lg mx-auto">
        <div class="win-xp-title-bar">Quiz Application</div>
        <div class="p-8 space-y-6">
            <!-- Initial View: Role Selection -->
            <div id="role-selection-view" class="text-center">
                <h1 class="text-2xl font-bold mb-6 text-black">Welcome to the Quiz!</h1>
                <p class="text-black mb-8">Please select your role to continue.</p>
                <div class="space-y-4">
                    <button onclick="showLogin('admin')" class="w-full py-2 px-4 win-xp-button">I am an Admin</button>
                    <button onclick="showLogin('participant')" class="w-full py-2 px-4 win-xp-button">I am a Participant</button>
                </div>
            </div>

            <!-- Login View -->
            <div id="login-view" class="hidden text-center">
                <h2 id="login-title" class="text-xl font-bold mb-6 text-black"></h2>
                <input type="password" id="password-input" class="w-full p-2 mb-4 win-xp-input" placeholder="Enter Password">
                <input type="text" id="name-input" class="w-full p-2 mb-4 hidden win-xp-input" placeholder="Enter Your Name/Team Name">
                <button onclick="handleLogin()" class="w-full py-2 px-4 win-xp-button bg-green-500 text-white font-bold">Continue</button>
                <button onclick="showRoleSelection()" class="mt-4 text-blue-700 hover:underline">Go Back</button>
                <p id="login-error" class="text-red-700 mt-4"></p>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden text-center">
                <h2 class="text-xl font-bold mb-2 text-black">Admin Dashboard</h2>
                <p class="text-black mb-6">Control the quiz from here.</p>
                <div id="admin-status" class="mb-6 p-4 bg-gray-200 rounded-sm border border-gray-400"></div>
                <div id="admin-timer" class="hidden text-2xl font-bold text-red-600 bg-white p-2 rounded-sm border border-gray-400 my-4 mx-auto w-fit"></div>
                <button id="start-quiz-btn" onclick="startQuiz()" class="w-full py-2 px-4 win-xp-button bg-blue-600 text-white font-bold disabled:bg-gray-400 disabled:text-gray-700">Start Quiz</button>
                <button id="show-results-btn" onclick="showAdminResults()" class="hidden mt-4 w-full py-2 px-4 win-xp-button bg-green-500 text-white font-bold">Show Results</button>
                <button onclick="resetQuiz()" class="mt-4 w-full py-2 px-4 win-xp-button bg-red-600 text-white font-bold">Reset Quiz</button>
                
                <div id="admin-ranking-view" class="hidden mt-6 text-left bg-white p-4 border border-gray-400 rounded-sm">
                    <h3 class="text-lg font-bold mb-4 text-center">Final Results</h3>
                    <div id="admin-ranking-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Participant View -->
            <div id="participant-view" class="hidden">
                <!-- Waiting Screen -->
                <div id="waiting-screen" class="text-center">
                    <h2 class="text-xl font-bold mb-4 text-black">Welcome, <span id="participant-name"></span>!</h2>
                    <p class="text-black mb-6">The quiz will begin shortly. Please wait for the admin to start.</p>
                    <div class="loader mx-auto"></div>
                </div>

                <!-- Quiz Screen -->
                <div id="quiz-screen" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-black">Quiz in Progress</h2>
                        <div id="timer" class="text-xl font-bold text-red-600 bg-white p-2 rounded-sm border border-gray-400">01:00</div>
                    </div>
                    <div id="question-container" class="bg-white p-4 border border-gray-400 rounded-sm">
                        <p class="text-md font-bold mb-4" id="question-text"></p>
                        <div id="options-container" class="space-y-2"></div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="prev-btn" onclick="navigateQuestion(-1)" class="py-2 px-6 win-xp-button">Previous</button>
                        <button id="next-btn" onclick="navigateQuestion(1)" class="py-2 px-6 win-xp-button bg-blue-600 text-white">Next</button>
                        <button id="submit-btn" onclick="submitQuiz()" class="hidden py-2 px-6 win-xp-button bg-green-500 text-white">Submit</button>
                    </div>
                </div>

                <!-- Ranking Screen -->
                <div id="ranking-screen" class="hidden text-center">
                     <div class="bg-white p-6 border border-gray-400 rounded-sm">
                         <h2 class="text-2xl font-bold mb-6 text-black">Quiz Over!</h2>
                         <p class="text-black mb-6">Here are the final rankings:</p>
                         <div id="ranking-list" class="space-y-2 text-left"></div>
                     </div>
                     <button onclick="showRoleSelection()" class="mt-8 py-2 px-4 win-xp-button bg-blue-600 text-white font-bold">Play Again</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRyBGcSgLaH6jbqgDY9Yn8t1Rw9o-jWJw",
            authDomain: "nspd25-996bf.firebaseapp.com",
            databaseURL: "https://nspd25-996bf-default-rtdb.firebaseio.com",
            projectId: "nspd25-996bf",
            storageBucket: "nspd25-996bf.appspot.com",
            messagingSenderId: "678844470957",
            appId: "1:678844470957:web:04a29772c95ebf67c21824",
            measurementId: "G-GRCBT2KMKH"
        };

        // --- App Initialization ---
        let app, db, auth, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.body.innerHTML = `<div class="text-red-500 p-4">Error: Firebase configuration is missing or invalid.</div>`;
        }

        // --- Global State ---
        let currentRole = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizTimerInterval;
        let cornerTimerInterval;
        let adminTimerInterval;
        let audioCtx; // For generating sound
        let quizStartTime;
        let participantDocId = null;
        let isSubmitted = false;
        let participantQuiz = []; // Holds the shuffled quiz for the current participant
        const quizDuration = 60;
        const questions = [
            {
                text: "Why does the Chandrasekhar limit exist only for electron-degenerate matter and not for neutron stars or black holes?",
                options: [
                    "Electrons become relativistic, whereas in neutron matter the interactions behave differently and do not yield a sharp mass cutoff",
                    "Electron degeneracy pressure saturates relativistically; neutron stars are set by strong-interaction EOS; black holes ignore pressure once horizons form",
                    "Pair-production processes destabilize electron gases but do not influence neutrons or black holes in the same way",
                    "Photon pressure dominates at extreme densities, preventing the same type of limiting mass behavior from occurring in all cases"
                ],
                correctAnswer: 1
            },
            {
                text: "Why is iron the end point of stellar nucleosynthesis in massive stars?",
                options: [
                    "Iron nuclei collect in the stellar core where their nuclear binding resists fusion, altering energy transport and halting reactions",
                    "Fusion beyond iron consumes energy; binding energy per nucleon peaks, so further fusion is endothermic",
                    "Neutrino-driven processes fragment heavier nuclei more easily than iron, making iron the most stable core product",
                    "Radiation pressure inside advanced stellar cores disrupts iron-group nuclei, preventing stable production of heavier species"
                ],
                correctAnswer: 1
            },
            {
                text: "What drives the κ-mechanism pulsations in Cepheid and RR Lyrae stars?",
                options: [
                    "Magnetic buoyancy modifies opacity in ionization zones, storing energy and later releasing it in an oscillatory pattern",
                    "Stellar winds create shock fronts in the atmosphere, and reflected energy cycles drive the observed radial pulsations",
                    "Ionization-zone opacity increase traps heat, raising pressure and causing cyclic expansion/contraction",
                    "Rapid stellar rotation alters centrifugal balance, changing gravity darkening and producing apparent pulsation signatures"
                ],
                correctAnswer: 2
            },
            {
                text: "Why do galaxy rotation curves remain flat at large radii?",
                options: [
                    "Gas pressure in extended disks contributes additional dynamical support that mimics the presence of extra unseen mass",
                    "Gravitational torques from interactions with nearby galaxies inject angular momentum into outer stellar populations",
                    "Non-luminous dark matter halo dominates the mass distribution at large radii",
                    "Strong stellar winds and radiation fields accelerate stars in the outskirts, sustaining orbital speeds against gravity"
                ],
                correctAnswer: 2
            },
            {
                text: "Pop I vs Pop II stars differ primarily because:",
                options: [
                    "Both populations cover similar age ranges, but their distinct initial mass distributions set evolutionary differences",
                    "Pop I stars preferentially form in halos, while Pop II stars are observed more abundantly in galactic disks",
                    "Chemical enrichment over time makes Pop I metal-rich in disks; Pop II metal-poor in halo/bulge",
                    "Nuclear burning cycles differ, with Pop II relying mainly on the CNO cycle while Pop I remains dominated by pp chains"
                ],
                correctAnswer: 2
            },
            {
                text: "Why do more massive stars live shorter lives?",
                options: [
                    "Their interiors remain cooler and less dense, which paradoxically causes them to process nuclear fuel inefficiently",
                    "Convective zones restrict mixing, leaving some hydrogen unburned and limiting the total available nuclear energy",
                    "Higher core temperatures cause vastly higher fusion rates that outpace the extra fuel",
                    "Strong stellar winds strip mass quickly, forcing them to exhaust their fuel supply regardless of the larger reservoir"
                ],
                correctAnswer: 2
            },
            {
                text: "Why are CO rotational transitions used to trace H₂ clouds?",
                options: [
                    "Cold H₂ molecules emit bright low-frequency radiation in radio bands, making them easily detectable directly",
                    "CO molecules are destroyed at the same ultraviolet rates as H₂, ensuring both species trace identical environments",
                    "CO has bright rotational lines excited at cloud temperatures; H₂ lacks a dipole and is hard to excite",
                    "Unlike most molecules, CO remains in the gas phase without freezing onto dust, marking the same regions as H₂"
                ],
                correctAnswer: 2
            },
            {
                text: "Why are globular clusters old and metal-poor while open clusters are young and metal-rich?",
                options: [
                    "Globular clusters constantly accrete pristine intergalactic gas, which dilutes enrichment products from earlier stars",
                    "Open clusters are associated with galactic halos, and their location explains their younger age and higher metallicity",
                    "Globulars formed early with unenriched gas; open clusters form later in enriched disks and disperse quickly",
                    "Continuous stellar winds from early stars prevented globulars from retaining heavy elements, unlike younger clusters"
                ],
                correctAnswer: 2
            },
            {
                text: "What does the Magorrian relation imply about galaxy–black hole co-evolution?",
                options: [
                    "Bulge growth proceeds independently and occurs after black hole accretion has essentially finished",
                    "Co-evolution: black-hole feedback and bulge assembly are linked through gas inflow/outflow regulation",
                    "Black-hole mass is determined solely by the angular momentum of the surrounding dark matter halo",
                    "The disk’s rotational dynamics directly fix the black-hole mass through long-term gravitational coupling"
                ],
                correctAnswer: 1
            },
            {
                text: "What role does the Jeans criterion play in star formation?",
                options: [
                    "It sets the threshold at which turbulence-driven heating becomes strong enough to halt collapse in molecular gas",
                    "It defines the regime where magnetic-field amplification alters the stability of interstellar clouds",
                    "Whether self-gravity overcomes pressure on a given scale to trigger collapse",
                    "It determines when icy mantles on dust grains accumulate, allowing clouds to cool efficiently and collapse"
                ],
                correctAnswer: 2
            },
            {
                text: "Why are OB associations found in spiral arms but not in ellipticals?",
                options: [
                    "Elliptical galaxies contain very few stars, making them unable to support associations of massive O and B types",
                    "Spiral shocks compress gas; ellipticals lack cold, dense gas and spiral density waves",
                    "OB stars cannot form in metal-rich environments, and elliptical galaxies are dominated by enriched stellar populations",
                    "Spiral arms prevent supernova feedback from disrupting clusters, while ellipticals lack such structures"
                ],
                correctAnswer: 1
            },
            {
                text: "Why do AGN show broad emission lines?",
                options: [
                    "Gravitational redshift broadens lines in the narrow-line region far from the black hole",
                    "Dust scattering within the circumnuclear torus produces apparent spectral broadening across many lines",
                    "High-velocity gas near the black hole produces Doppler broadening; orientation and virial motions dominate",
                    "Absorption by stellar atmospheres artificially fills in narrow lines, making them appear broad in observations"
                ],
                correctAnswer: 2
            },
            {
                text: "How do Seyfert Type 1 and Type 2 galaxies differ spectroscopically?",
                options: [
                    "Type 1 spectra display only narrow emission lines, whereas Type 2 show exclusively broad emission lines",
                    "Type 1 shows broad + narrow emission lines; Type 2 shows only narrow lines due to orientation and obscuration",
                    "Type 1 is dominated by absorption features, while Type 2 galaxies contain emission-only line spectra",
                    "Both appear identical spectroscopically, and the classification is thought to be entirely historical in origin"
                ],
                correctAnswer: 1
            },
            {
                text: "Why does stellar metallicity generally decline with galactocentric radius?",
                options: [
                    "Star formation efficiency remains uniform across the galaxy, leading to a flat metallicity distribution",
                    "Outer disks preferentially lose heavy elements due to radiation-driven winds that expel enriched material",
                    "Inside-out growth and higher central star formation enrich inner regions more than outskirts",
                    "Metal production is confined to galactic bulges, and stars formed elsewhere inherit lower abundances"
                ],
                correctAnswer: 2
            },
            {
                text: "What is the physical origin of the Eddington limit?",
                options: [
                    "Electron capture at extreme densities halts further collapse, imposing a luminosity restriction",
                    "Luminosity where radiation force on electrons balances gravity on ions, regulating accretion/outflows",
                    "The centrifugal force at high spin rates equals gravity, marking a critical threshold for stellar stability",
                    "The concept applies strictly to stars and does not extend to accretion disks or compact objects"
                ],
                correctAnswer: 1
            },
            {
                text: "Why do pulsars spin down over time?",
                options: [
                    "Nuclear burning ceases in their cores, reducing angular momentum and slowing rotation",
                    "Magnetic dipole radiation and particle winds extract rotational energy and angular momentum",
                    "Accretion of matter onto the crust builds inertia that counteracts and slows the star’s spin",
                    "Gravitational tides from nearby objects exert drag that gradually decreases the pulsar’s spin rate"
                ],
                correctAnswer: 1
            },
            {
                text: "How is pressure support different in main-sequence stars vs white dwarfs?",
                options: [
                    "Both types of stars are supported by ordinary gas pressure and do not rely on any other mechanisms",
                    "Main-sequence stars rely solely on radiation pressure, while white dwarfs depend only on gas pressure",
                    "MS: thermal gas (and sometimes radiation) from fusion; WD: electron degeneracy independent of temperature",
                    "White dwarfs are stabilized mainly through large-scale magnetic fields that balance gravitational collapse"
                ],
                correctAnswer: 2
            },
            {
                text: "Why are RR Lyrae stars used as standard candles differently from Cepheids?",
                options: [
                    "RR Lyrae are universally younger stars than Cepheids, and their uniform age makes them useful for calibration",
                    "RR Lyrae have nearly constant luminosity; Cepheids use period–luminosity relation",
                    "Cepheids are restricted to globular clusters, whereas RR Lyrae occur across diverse galactic environments",
                    "RR Lyrae variability is stochastic in nature, limiting their use to simplified luminosity comparisons"
                ],
                correctAnswer: 1
            },
            {
                text: "Why does the Milky Way halo contain mostly pressure-supported stars rather than rotation-supported ones?",
                options: [
                    "Halo stars are predominantly young objects that have not yet acquired significant angular momentum",
                    "Halo assembled through mergers and scattering, producing isotropic velocity dispersions",
                    "Dark-matter gravity suppresses ordered rotation, forcing halo stars to move in random orbits",
                    "Halo gas cooled quickly and fragmented, leading to a stellar system dominated by chaotic motions"
                ],
                correctAnswer: 1
            },
            {
                text: "Why do synchrotron-emitting electrons in galaxies indicate past supernova activity?",
                options: [
                    "Dust scattering enhances ambient magnetic fields, boosting electron energy to relativistic levels",
                    "Electrons must be relativistically accelerated in shocks, most efficiently provided by supernova remnants",
                    "Stellar surfaces directly radiate synchrotron emission, and remnants only add to the observed flux",
                    "Large-scale cosmic expansion accelerates galactic electrons to high energies, producing the radiation"
                ],
                correctAnswer: 1
            }
        ];

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                setupQuizStateListener();
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        // --- UI Navigation ---
        const views = ['role-selection-view', 'login-view', 'admin-view', 'participant-view'];
        function showView(viewId) {
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        window.showLogin = (role) => {
            currentRole = role;
            showView('login-view');
            document.getElementById('login-title').innerText = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
            document.getElementById('login-error').innerText = '';
            document.getElementById('password-input').value = '';
            const nameInput = document.getElementById('name-input');
            nameInput.classList.toggle('hidden', role !== 'participant');
            if (role === 'participant') nameInput.value = '';
        };

        window.showRoleSelection = () => {
            clearInterval(quizTimerInterval);
            clearInterval(adminTimerInterval);
            stopCornerCountdown();
            participantDocId = null;
            isSubmitted = false;
            showView('role-selection-view');
            document.getElementById('waiting-screen').style.display = 'block';
            document.getElementById('waiting-screen').innerHTML = `<h2 class="text-xl font-bold mb-4 text-black">Welcome, <span id="participant-name"></span>!</h2><p class="text-black mb-6">The quiz will begin shortly. Please wait for the admin to start.</p><div class="loader mx-auto"></div>`;
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('ranking-screen').classList.add('hidden');
        };
        
        // --- Login Logic ---
        window.handleLogin = async () => {
            const password = document.getElementById('password-input').value;
            const name = document.getElementById('name-input').value;
            const errorEl = document.getElementById('login-error');

            if (!password || (currentRole === 'participant' && !name)) {
                errorEl.innerText = "All fields are required.";
                return;
            }

            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }

                const configDoc = await getDoc(doc(db, "quizConfig", "passwords"));
                if (!configDoc.exists()) {
                    await setDoc(doc(db, "quizConfig", "passwords"), { admin: "terabaap", participant: "nspd25" });
                    errorEl.innerText = "First-time setup complete. Default passwords have been set. Please try again.";
                    return;
                }
                
                const passwords = configDoc.data();
                if (currentRole === 'admin' && password === passwords.admin) {
                    showView('admin-view');
                } else if (currentRole === 'participant' && password === passwords.participant) {
                    isSubmitted = false;
                    const newDocRef = await addDoc(collection(db, "participants"), {
                        name: name, authUid: userId, answers: {}, score: 0, timeTaken: 0, submitted: false
                    });
                    participantDocId = newDocRef.id;
                    document.getElementById('participant-name').innerText = name;
                    showView('participant-view');
                } else {
                    errorEl.innerText = "Incorrect password.";
                }
            } catch (e) {
                console.error("Login error:", e);
                errorEl.innerText = "An error occurred.";
            }
        };

        // --- Real-Time Listener ---
        function setupQuizStateListener() {
            onSnapshot(doc(db, "quizState", "current"), (docSnap) => {
                const state = docSnap.exists() ? docSnap.data() : { status: 'waiting' };
                updateAdminStatus(`Status: ${state.status}`);
                document.getElementById('start-quiz-btn').disabled = state.status === "running";
                document.getElementById('show-results-btn').classList.toggle('hidden', state.status !== 'finished');
                
                if (currentRole === 'admin') {
                    if (state.status === 'running') {
                        startAdminTimer(state);
                    } else {
                        stopAdminTimer();
                    }
                }

                if (state.status !== 'finished') {
                    document.getElementById('admin-ranking-view').classList.add('hidden');
                }
                if (currentRole === 'participant') handleParticipantStateChange(state);
            });
        }

        async function handleParticipantStateChange(state) {
            const waitingScreen = document.getElementById('waiting-screen');
            const quizScreen = document.getElementById('quiz-screen');
            const rankingScreen = document.getElementById('ranking-screen');

            switch(state.status) {
                case 'waiting':
                    waitingScreen.style.display = 'block';
                    quizScreen.classList.add('hidden');
                    rankingScreen.classList.add('hidden');
                    stopCornerCountdown();
                    break;
                case 'running':
                    if (quizScreen.classList.contains('hidden') && !isSubmitted) {
                        waitingScreen.style.display = 'none';
                        quizScreen.classList.remove('hidden');
                        rankingScreen.classList.add('hidden');
                        startParticipantQuiz(state);
                    }
                    break;
                case 'finished':
                    if (!isSubmitted) {
                        await submitQuiz(true);
                    }
                    clearInterval(quizTimerInterval);
                    stopCornerCountdown();
                    waitingScreen.style.display = 'none';
                    quizScreen.classList.add('hidden');
                    rankingScreen.classList.remove('hidden');
                    displayRankings();
                    break;
            }
        }
        
        function updateAdminStatus(message) {
            const statusEl = document.getElementById('admin-status');
            if (statusEl) statusEl.innerText = message;
        }

        // --- Admin Actions ---
        window.startQuiz = async () => {
            await setDoc(doc(db, "quizState", "current"), { status: "running", startTime: Date.now() });
            setTimeout(async () => {
                await setDoc(doc(db, "quizState", "current"), { status: "finished" }, { merge: true });
            }, quizDuration * 1000);
        };

        window.resetQuiz = async () => {
            if (!confirm("Are you sure you want to reset the quiz? All participant data will be deleted.")) {
                return;
            }
            await setDoc(doc(db, "quizState", "current"), { status: "waiting" });
            const participantsSnapshot = await getDocs(collection(db, "participants"));
            const batch = writeBatch(db);
            participantsSnapshot.forEach((doc) => batch.delete(doc.ref));
            await batch.commit();
            alert("Quiz and all participant data have been reset.");
        };
        
        window.showAdminResults = () => {
            const rankingView = document.getElementById('admin-ranking-view');
            rankingView.classList.toggle('hidden');
            if (!rankingView.classList.contains('hidden')) displayAdminRankings();
        };

        // --- Sound and Timer Functions ---
        function playBeep(duration = 0.1, freq = 880) {
            if (!audioCtx || audioCtx.state === 'suspended') return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration);
        }
        
        function createCountdown(element, state, playSound = false) {
            const globalStartTime = state.startTime;
            const update = () => {
                const elapsedSeconds = Math.floor((Date.now() - globalStartTime) / 1000);
                let timeLeft = quizDuration - elapsedSeconds;
                if (timeLeft >= 0) {
                    element.innerText = `${String(Math.floor(timeLeft/60)).padStart(2,'0')}:${String(timeLeft%60).padStart(2,'0')}`;
                    if (playSound) {
                        if (timeLeft === 10) playBeep(0.5);
                        else if (timeLeft < 10 && timeLeft > 0) playBeep();
                        else if (timeLeft === 0) playBeep(0.7, 523);
                    }
                } else {
                    element.innerText = "00:00";
                    return true;
                }
                return false;
            };
            return update;
        }

        function startAdminTimer(state) {
            const timerEl = document.getElementById('admin-timer');
            if (!timerEl) return;
            timerEl.classList.remove('hidden');
            if (adminTimerInterval) clearInterval(adminTimerInterval);
            const update = createCountdown(timerEl, state, true);
            update();
            adminTimerInterval = setInterval(() => {
                if (update()) clearInterval(adminTimerInterval);
            }, 1000);
        }

        function stopAdminTimer() {
            const timerEl = document.getElementById('admin-timer');
            if (timerEl) timerEl.classList.add('hidden');
            clearInterval(adminTimerInterval);
        }

        function startCornerCountdown(state) {
            const cornerTimerEl = document.getElementById('corner-countdown');
            if (!cornerTimerEl) return;
            cornerTimerEl.classList.remove('hidden');
            if (cornerTimerInterval) clearInterval(cornerTimerInterval);
            const update = createCountdown(cornerTimerEl, state);
            update();
            cornerTimerInterval = setInterval(() => {
                if (update()) clearInterval(cornerTimerInterval);
            }, 1000);
        }

        function stopCornerCountdown() {
            const cornerTimerEl = document.getElementById('corner-countdown');
            if (cornerTimerEl) cornerTimerEl.classList.add('hidden');
            clearInterval(cornerTimerInterval);
        }

        // --- Participant Quiz Logic ---
        function startParticipantQuiz(state) {
            currentQuestionIndex = 0;
            userAnswers = {};
            quizStartTime = Date.now();
            
            // Shuffle questions and options ONCE at the start for this participant
            participantQuiz = questions.map(q => {
                const optionsToShuffle = q.options.map((optionText, index) => ({
                    text: optionText,
                    originalIndex: index
                }));
                shuffleArray(optionsToShuffle);
                return {
                    text: q.text,
                    shuffledOptions: optionsToShuffle,
                };
            });

            renderQuestion();
            startCornerCountdown(state);

            const timerEl = document.getElementById('timer');
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            const update = createCountdown(timerEl, state, true);
            update();
            quizTimerInterval = setInterval(() => {
                if (update()) {
                    clearInterval(quizTimerInterval);
                }
            }, 1000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderQuestion() {
            const question = participantQuiz[currentQuestionIndex];
            document.getElementById('question-text').innerText = `${currentQuestionIndex + 1}. ${question.text}`;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            question.shuffledOptions.forEach(shuffledOption => {
                const isSelected = userAnswers[currentQuestionIndex] === shuffledOption.originalIndex;
                const button = document.createElement('button');
                button.innerText = shuffledOption.text;
                button.className = `w-full text-left p-2 win-xp-button ${isSelected ? 'bg-blue-300' : 'bg-white'}`;
                button.onclick = () => selectAnswer(shuffledOption.originalIndex);
                optionsContainer.appendChild(button);
            });

            document.getElementById('prev-btn').style.visibility = currentQuestionIndex === 0 ? 'hidden' : 'visible';
            document.getElementById('next-btn').classList.toggle('hidden', currentQuestionIndex === questions.length - 1);
            document.getElementById('submit-btn').classList.toggle('hidden', currentQuestionIndex !== questions.length - 1);
        }

        function selectAnswer(originalIndex) {
            userAnswers[currentQuestionIndex] = originalIndex;
            renderQuestion();
        }

        window.navigateQuestion = (direction) => {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < questions.length) {
                currentQuestionIndex = newIndex;
                renderQuestion();
            }
        };

        window.submitQuiz = async (isAutoSubmit = false) => {
            if (isSubmitted) return;
            isSubmitted = true;

            clearInterval(quizTimerInterval);
            stopCornerCountdown();
            if (!participantDocId) return console.error("Cannot submit: No participant document ID.");
            
            let score = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correctAnswer) score++;
            }
            try {
                await setDoc(doc(db, "participants", participantDocId), {
                    score: score, timeTaken: Math.round((Date.now() - quizStartTime) / 1000), submitted: true, answers: userAnswers
                }, { merge: true });
                if (!isAutoSubmit) {
                    document.getElementById('quiz-screen').classList.add('hidden');
                    document.getElementById('waiting-screen').style.display = 'block';
                    document.getElementById('waiting-screen').innerHTML = `<h2 class="text-xl font-bold mb-4 text-black">Submission successful!</h2><p class="text-black">Waiting for results...</p><div class="loader mx-auto mt-6"></div>`;
                }
            } catch (e) {
                console.error("Error submitting quiz:", e);
                const errorEl = document.getElementById('quiz-screen');
                errorEl.innerHTML = `<p class="text-red-700 text-center p-4">Could not submit your answers. Please check your connection.</p>`;
            }
        };

        // --- Ranking Logic ---
        async function displayRankings() { await renderRankingList(document.getElementById('ranking-list')); }
        async function displayAdminRankings() { await renderRankingList(document.getElementById('admin-ranking-list')); }

        async function renderRankingList(targetElement) {
            try {
                targetElement.innerHTML = '<div class="loader mx-auto"></div>';
                const participantsSnapshot = await getDocs(collection(db, "participants"));
                const rankings = [];
                participantsSnapshot.forEach(doc => rankings.push(doc.data()));
                rankings.sort((a, b) => b.score - a.score || a.timeTaken - b.timeTaken);
                targetElement.innerHTML = '';
                if (rankings.length === 0) {
                    targetElement.innerHTML = '<p class="text-center">No participants have joined yet.</p>';
                    return;
                }
                rankings.forEach((p, index) => {
                    const rankEl = document.createElement('div');
                    let rankClasses = 'flex justify-between items-center p-2 rounded-sm border ';
                    let resultHtml;
                    if (p.submitted) {
                        if (index === 0) rankClasses += 'bg-yellow-200 border-yellow-400';
                        else if (index === 1) rankClasses += 'bg-gray-300 border-gray-400';
                        else if (index === 2) rankClasses += 'bg-orange-200 border-orange-400';
                        else rankClasses += 'bg-gray-200 border-gray-300';
                        resultHtml = `<div class="text-right"><span class="font-bold text-blue-700">${p.score}/${questions.length}</span><span class="text-sm text-black ml-2">(${p.timeTaken}s)</span></div>`;
                    } else {
                        rankClasses += 'bg-red-200 border-red-400 opacity-70';
                        resultHtml = `<div class="text-right"><span class="text-sm font-bold text-red-800">Did not finish</span></div>`;
                    }
                    rankEl.className = rankClasses;
                    rankEl.innerHTML = `<div class="flex items-center"><span class="font-bold text-lg w-8">${index + 1}.</span><span class="font-bold text-black">${p.name}</span></div>${resultHtml}`;
                    targetElement.appendChild(rankEl);
                });
            } catch (e) {
                console.error("Error fetching rankings:", e);
                targetElement.innerHTML = '<p class="text-red-700 text-center">Could not load rankings.</p>';
            }
        }
        
        // Initial setup
        showView('role-selection-view');
        window.showRoleSelection = showRoleSelection;

    </script>
</body>
</html>
