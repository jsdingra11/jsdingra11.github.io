<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINISTRY OF MAGIC | Admin Console</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --magic-gold: #c5a059;
            --magic-blue: #74c7d5; 
            --dark-bg: #050508;
            --danger-red: #ef4444;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
        }

        body {
            background-color: var(--dark-bg);
            color: #b0b0b0;
            font-family: 'Inter', sans-serif; /* Default to clean font */
            overflow-x: hidden;
            cursor: default;
        }

        /* Specialized Fonts */
        .font-magic { font-family: 'Cinzel', serif; }
        .font-book { font-family: 'Crimson Text', serif; }
        .font-data { font-family: 'Inter', sans-serif; }

        /* Inputs */
        .input-field {
            background: rgba(10, 15, 20, 0.7);
            border: 1px solid #2f3e46;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--magic-blue);
            box-shadow: 0 0 10px rgba(116, 199, 213, 0.2);
        }
        
        /* Buttons */
        .btn-magic {
            background: linear-gradient(45deg, #0f1c25, #1a2a35);
            border: 1px solid var(--magic-gold);
            color: var(--magic-gold);
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .btn-magic:hover {
            background: linear-gradient(45deg, #1a2a35, #2c3e50);
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.2);
        }
        .btn-danger {
            border: 1px solid var(--danger-red);
            color: var(--danger-red);
        }
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
        }
        .btn-success {
            border: 1px solid var(--success-green);
            color: var(--success-green);
        }
        .btn-success:hover {
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }
        .btn-warning {
            border: 1px solid var(--warning-yellow);
            color: var(--warning-yellow);
        }
        .btn-warning:hover {
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
        }

        /* Ambient Effects */
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at center, #111118 0%, #000000 100%); }
        
        .glass-panel { background: rgba(5, 5, 8, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(197, 160, 89, 0.2); box-shadow: 0 0 30px rgba(0,0,0,0.8); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f1c25; }
        ::-webkit-scrollbar-thumb { background: #3a4a5a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #c5a059; }
    </style>
</head>
<body class="min-h-screen flex flex-col font-data">

    <div id="canvas-container"></div>
    
    <header class="w-full p-6 border-b border-[#c5a059]/20 bg-black/50 backdrop-blur-md flex justify-between items-center z-50 sticky top-0">
        <div class="flex items-center gap-4">
            <img src="scirox.png" alt="Logo" class="h-10 opacity-80" onerror="this.style.display='none'">
            <div>
                <h1 class="text-xl text-[#c5a059] font-bold font-magic tracking-widest uppercase">Ministry Archives</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-[0.3em] font-data">Confidential ‚Ä¢ Department of Mysteries</p>
            </div>
        </div>
        <div>
            <button onclick="location.reload()" class="text-xs text-red-400 hover:text-white uppercase tracking-widest border border-red-900/50 hover:bg-red-900/20 px-4 py-2 rounded-sm transition font-magic">
                Log Out
            </button>
        </div>
    </header>

    <main class="flex-grow p-6 relative z-10 w-full max-w-[2000px] mx-auto">
        
        <div id="loading-screen" class="fixed inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-[#c5a059]/20 border-t-[#c5a059] rounded-full animate-spin mb-4"></div>
            <p class="text-[#c5a059] animate-pulse font-magic tracking-widest uppercase text-sm">Decrypting Runes...</p>
        </div>

        <div id="admin-login-view" class="min-h-[60vh] flex flex-col items-center justify-center">
            <div class="glass-panel p-10 rounded-sm max-w-md w-full text-center">
                <div class="mb-6 text-4xl">üîí</div>
                <h3 class="text-2xl text-[#c5a059] mb-2 font-bold font-magic uppercase tracking-widest">Identify Yourself</h3>
                <p class="text-xs text-gray-500 mb-8 font-book italic">Only authorized personnel may handle the Goblet's data.</p>
                
                <div class="space-y-4">
                    <input type="password" id="admin-pass" class="w-full p-4 rounded-sm input-field text-center tracking-[0.2em] placeholder-gray-700" placeholder="PASSPHRASE">
                    <button id="admin-login-btn" class="w-full py-4 btn-magic rounded-sm font-bold text-lg">
                        Alohomora
                    </button>
                </div>
            </div>
        </div>

        <div id="admin-dashboard-view" class="hidden animate-fade-in-up">
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-panel p-4 rounded-sm border-l-4 border-l-[#c5a059]">
                    <p class="text-gray-500 text-[10px] uppercase tracking-widest mb-1 font-data">Total Teams</p>
                    <h2 id="stat-teams" class="text-3xl text-white font-magic font-bold">0</h2>
                </div>
                <div class="glass-panel p-4 rounded-sm border-l-4 border-l-[#74c7d5]">
                    <p class="text-gray-500 text-[10px] uppercase tracking-widest mb-1 font-data">Total Wizards</p>
                    <h2 id="stat-wizards" class="text-3xl text-white font-magic font-bold">0</h2>
                </div>
                <div class="glass-panel p-4 rounded-sm border-l-4 border-l-green-500">
                    <p class="text-gray-500 text-[10px] uppercase tracking-widest mb-1 font-data">Vault (Galleons)</p>
                    <h2 id="stat-revenue" class="text-3xl text-green-400 font-magic font-bold">‚Çπ0</h2>
                </div>
                <div class="glass-panel p-4 flex items-center justify-center">
                    <button id="refresh-btn" class="text-xs text-[#c5a059] hover:text-white flex items-center gap-2 uppercase tracking-widest font-magic">
                        <span class="text-xl">‚Üª</span> Refresh Data
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <div class="relative max-w-md">
                    <input type="text" id="search-input" placeholder="Search by Team, Captain, or Email..." 
                        class="w-full p-4 pl-12 rounded-sm bg-black/40 border border-[#c5a059]/30 text-white font-data focus:outline-none focus:border-[#c5a059] focus:ring-1 focus:ring-[#c5a059] placeholder-gray-600 transition-all shadow-[0_0_15px_rgba(0,0,0,0.5)]">
                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-[#c5a059] text-lg">üîç</span>
                </div>
            </div>

            <div class="glass-panel rounded-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-black/80 text-[#c5a059] uppercase text-[10px] tracking-widest font-magic border-b border-[#c5a059]/30 whitespace-nowrap">
                            <tr>
                                <th class="px-4 py-4 text-center w-16">Status</th>
                                <th class="px-4 py-4 font-bold">Date</th>
                                <th class="px-4 py-4 font-bold text-lg">Team Name</th>
                                <th class="px-4 py-4 font-bold text-center text-[#c5a059]">Ref. Points</th> <th class="px-4 py-4 font-bold">Captain Name</th>
                                <th class="px-4 py-4 font-bold">Dept</th>
                                <th class="px-4 py-4 font-bold text-center">Contact (Captain)</th>
                                <th class="px-4 py-4 font-bold">Party Members</th>
                                <th class="px-4 py-4 font-bold text-center">Proof</th>
                                <th class="px-4 py-4 font-bold text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="divide-y divide-[#c5a059]/10 font-data">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <p class="text-center text-gray-600 text-[10px] mt-8 uppercase tracking-widest font-magic">Confidentiality Statute Strictly Enforced</p>
        </div>

    </main>

    <div id="modal" class="fixed inset-0 bg-black/95 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-[#111] border border-[#c5a059] p-8 max-w-md w-full text-center rounded-sm shadow-[0_0_30px_rgba(197,160,89,0.2)]">
            <h3 id="modal-title" class="text-xl text-[#c5a059] font-bold mb-4 font-magic uppercase tracking-widest">Notice</h3>
            <p id="modal-message" class="text-gray-400 mb-8 font-book text-sm">...</p>
            <div class="flex gap-4 justify-center">
                <button id="modal-cancel" onclick="closeModal()" class="px-6 py-2 border border-gray-600 text-gray-400 text-xs uppercase tracking-widest hover:text-white rounded-sm hidden font-magic">Cancel</button>
                <button id="modal-confirm" onclick="closeModal()" class="px-6 py-2 btn-magic w-full rounded-sm text-xs font-bold">Dissendium</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
            authDomain: "iist-fd6e8.firebaseapp.com",
            databaseURL: "https://iist-fd6e8-default-rtdb.firebaseio.com",
            projectId: "iist-fd6e8",
            storageBucket: "iist-fd6e8.firebasestorage.app",
            messagingSenderId: "692699808449",
            appId: "1:692699808449:web:120c8941a940d071f24a40"
        };

        // --- Globals ---
        let app, auth, db;
        let deleteTargetKey = null;
        let allRegistrations = {}; // Store raw data for search filtering

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const adminLoginView = document.getElementById('admin-login-view');
        const adminDashboardView = document.getElementById('admin-dashboard-view');
        
        const adminPassInput = document.getElementById('admin-pass');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const searchInput = document.getElementById('search-input'); 
        
        const tableBody = document.getElementById('admin-table-body');
        const statTeams = document.getElementById('stat-teams');
        const statWizards = document.getElementById('stat-wizards');
        const statRevenue = document.getElementById('stat-revenue');

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');

        // --- Initialization ---
        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);
                
                // Silent auth to ensure DB access
                await signInAnonymously(auth);
                
                loadingScreen.classList.add('hidden');
            } catch (error) {
                console.error("Init Failed", error);
                loadingScreen.innerHTML = '<p class="text-red-500">Connection Severed. Check Console.</p>';
            }
        }

        // --- View Management ---
        function switchView(view) {
            adminLoginView.classList.add('hidden');
            adminDashboardView.classList.add('hidden');
            view.classList.remove('hidden');
        }

        // --- Auth Logic ---
        adminLoginBtn.addEventListener('click', async () => {
            const pass = adminPassInput.value.trim().toLowerCase();
            if(pass === 'alohomora' || pass === 'admin') {
                const originalText = adminLoginBtn.innerText;
                adminLoginBtn.innerText = "Unlocking...";
                adminLoginBtn.disabled = true;
                
                try {
                    await loadData();
                    switchView(adminDashboardView);
                } catch (e) {
                    showModal("Error", "Failed to retrieve archives. Check internet connection.");
                    console.error(e);
                    adminLoginBtn.innerText = originalText;
                    adminLoginBtn.disabled = false;
                }
            } else {
                showModal("Access Denied", "Incorrect Passphrase.");
                adminPassInput.value = '';
            }
        });

        // --- Data Logic ---
        refreshBtn.addEventListener('click', async () => {
            refreshBtn.innerHTML = '<span class="animate-spin">‚Üª</span> Fetching...';
            await loadData();
            refreshBtn.innerHTML = '<span class="text-xl">‚Üª</span> Refresh Data';
        });

        // --- Search Logic ---
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = Object.entries(allRegistrations).filter(([key, entry]) => {
                const tName = (entry.teamName || "").toLowerCase();
                const cName = (entry.captain?.name || "").toLowerCase();
                const cEmail = (entry.captain?.email || "").toLowerCase();
                
                return tName.includes(term) || cName.includes(term) || cEmail.includes(term);
            });
            
            const filteredObj = Object.fromEntries(filtered);
            renderTable(filteredObj);
        });

        async function loadData() {
            const snapshot = await get(ref(db, 'registrations'));
            if(snapshot.exists()) {
                allRegistrations = snapshot.val(); // Cache full dataset
                renderTable(allRegistrations);
            } else {
                allRegistrations = {};
                renderTable({});
            }
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            let tTeams = 0, tWizards = 0, tRevenue = 0;

            const entries = Object.entries(data).reverse(); // Newest first

            if (entries.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-8 text-gray-600 italic font-book">No records found.</td></tr>`;
                // Zero stats if empty
                statTeams.innerText = 0;
                statWizards.innerText = 0;
                statRevenue.innerText = `‚Çπ0`;
                return;
            }

            entries.forEach(([key, entry]) => {
                // --- 1. Ghost Filter: Skip malformed entries ---
                if (!entry || typeof entry !== 'object') return;
                if (!entry.teamName || !entry.captain || !entry.captain.name) return;

                // --- Stats Calculation ---
                tTeams++;
                const size = parseInt(entry.teamSize || 1);
                tWizards += size;
                tRevenue += (size * 50);

                // --- Referral Logic ---
                const refPoints = entry.referralPoints || 0;
                const refBy = entry.referredBy ? `via ${entry.referredBy}` : '';

                // --- Row Styles based on Status ---
                let rowClasses = "hover:bg-white/5 transition-colors group";
                let statusBadge = "";
                let actionButtons = "";

                // Determine Styles & Actions
                if (entry.status === 'accepted') {
                    rowClasses = "bg-green-900/10 hover:bg-green-900/20";
                    statusBadge = `<div class="w-2 h-2 rounded-full bg-green-500 mx-auto shadow-[0_0_10px_#10b981]" title="Accepted"></div>`;
                    
                    actionButtons = `
                        <div class="flex flex-col gap-2 items-end">
                             <button onclick="composeAcceptEmail('${entry.captain.email}', '${entry.teamName.replace(/'/g, "\\'")}', '${entry.captain.name.replace(/'/g, "\\'")}')" 
                                    class="bg-green-600/20 text-green-400 border border-green-600/50 hover:bg-green-600/40 px-3 py-1 rounded text-[10px] uppercase font-bold tracking-wider w-full text-center font-magic">
                                Send Mail ‚úâÔ∏è
                            </button>
                            <div class="flex gap-2">
                                <button onclick="setStatus('${key}', null)" class="text-gray-500 hover:text-white text-lg" title="Undo Decision">‚Ü∫</button>
                                <button onclick="triggerDelete('${key}')" class="text-red-500 hover:text-red-400 text-lg" title="Delete">üóë</button>
                            </div>
                        </div>
                    `;
                } else if (entry.status === 'rejected') {
                    rowClasses = "bg-red-900/10 hover:bg-red-900/20";
                    statusBadge = `<div class="w-2 h-2 rounded-full bg-red-500 mx-auto shadow-[0_0_10px_#ef4444]" title="Rejected"></div>`;
                    
                    actionButtons = `
                        <div class="flex flex-col gap-2 items-end">
                             <button onclick="composeRejectEmail('${entry.captain.email}', '${entry.teamName.replace(/'/g, "\\'")}', '${entry.captain.name.replace(/'/g, "\\'")}')" 
                                    class="bg-red-600/20 text-red-400 border border-red-600/50 hover:bg-red-600/40 px-3 py-1 rounded text-[10px] uppercase font-bold tracking-wider w-full text-center font-magic">
                                Send Mail ‚úâÔ∏è
                            </button>
                            <div class="flex gap-2">
                                <button onclick="setStatus('${key}', null)" class="text-gray-500 hover:text-white text-lg" title="Undo Decision">‚Ü∫</button>
                                <button onclick="triggerDelete('${key}')" class="text-red-500 hover:text-red-400 text-lg" title="Delete">üóë</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Pending
                    statusBadge = `<div class="w-2 h-2 rounded-full bg-yellow-500 mx-auto animate-pulse" title="Pending"></div>`;
                    actionButtons = `
                        <div class="flex justify-end gap-2">
                            <button onclick="setStatus('${key}', 'accepted')" 
                                    class="btn-success px-3 py-1 rounded text-[10px] uppercase font-bold tracking-wider hover:bg-green-500/10 font-magic">
                                Accept
                            </button>
                            <button onclick="setStatus('${key}', 'rejected')" 
                                    class="btn-warning px-3 py-1 rounded text-[10px] uppercase font-bold tracking-wider hover:bg-yellow-500/10 font-magic">
                                Reject
                            </button>
                            <button onclick="triggerDelete('${key}')" 
                                    class="btn-danger px-3 py-1 rounded text-[10px] uppercase font-bold tracking-wider hover:bg-red-500/10 font-magic">
                                Delete
                            </button>
                        </div>
                    `;
                }

                // --- Row Construction ---
                const row = document.createElement('tr');
                row.className = rowClasses;
                
                // --- MEMBERS HTML GENERATION ---
                let membersHtml = '';
                
                const getMemData = (mem) => {
                    if (!mem) return null;
                    return {
                        name: mem.name || null,
                        dept: mem.department || mem.dept || 'Unknown Dept',
                        phone: mem.phone || mem.contact || 'No Phone'
                    };
                };

                const m2 = getMemData(entry.member2);
                const m3 = getMemData(entry.member3);

                if (m2 && m2.name) {
                    membersHtml += `
                        <div class="mb-4 pb-2 border-b border-gray-800/50 last:border-0 last:mb-0 last:pb-0">
                            <div class="text-gray-300 font-bold text-sm font-data">${m2.name}</div>
                            <div class="flex flex-col mt-1">
                                <span class="text-[11px] text-gray-500 italic mb-1 font-data">${m2.dept}</span>
                                <span class="text-[#c5a059] font-data font-semibold text-base tracking-wide">üìû ${m2.phone}</span>
                            </div>
                        </div>`;
                }
                
                if (m3 && m3.name) {
                    membersHtml += `
                        <div class="mb-2 pb-2 border-b border-gray-800/50 last:border-0 last:mb-0 last:pb-0">
                            <div class="text-gray-300 font-bold text-sm font-data">${m3.name}</div>
                            <div class="flex flex-col mt-1">
                                <span class="text-[11px] text-gray-500 italic mb-1 font-data">${m3.dept}</span>
                                <span class="text-[#c5a059] font-data font-semibold text-base tracking-wide">üìû ${m3.phone}</span>
                            </div>
                        </div>`;
                }

                if(membersHtml === '') membersHtml = '<span class="text-gray-700 text-xs italic font-data">Solo Mission</span>';

                row.innerHTML = `
                    <td class="px-4 py-4 align-middle text-center border-l-4 ${entry.status === 'accepted' ? 'border-l-green-500' : entry.status === 'rejected' ? 'border-l-red-500' : 'border-l-transparent'}">
                        ${statusBadge}
                    </td>
                    <td class="px-4 py-4 align-middle">
                        <div class="text-xs text-gray-500 font-data">${new Date(entry.timestamp || Date.now()).toLocaleDateString()}</div>
                        <div class="text-[10px] text-gray-600 font-data">${new Date(entry.timestamp || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </td>
                    <td class="px-4 py-4 align-middle">
                        <div class="text-[#c5a059] font-bold text-lg font-magic tracking-wide drop-shadow-md">${entry.teamName}</div>
                    </td>
                    <td class="px-4 py-4 align-middle text-center">
                        <div class="text-xl font-bold font-magic ${refPoints > 0 ? 'text-[#c5a059] drop-shadow-[0_0_5px_rgba(197,160,89,0.5)]' : 'text-gray-700'}">
                            ${refPoints}
                        </div>
                        <div class="text-[9px] text-gray-500">${refBy}</div>
                    </td>
                    <td class="px-4 py-4 align-middle text-gray-300">
                        <div class="text-base font-bold font-data text-white">${entry.captain.name}</div>
                        <div class="text-xs text-[#74c7d5] hover:underline cursor-pointer mt-1 font-data font-medium" title="${entry.captain.email}" onclick="window.location.href='mailto:${entry.captain.email}'">
                            ‚úâ ${entry.captain.email}
                        </div>
                    </td>
                    <td class="px-4 py-4 align-middle text-sm italic text-gray-400 font-data">
                        ${entry.captain.department || 'Unknown'}
                    </td>
                    <td class="px-4 py-4 align-middle text-center">
                         <div class="text-lg text-[#c5a059] font-data font-bold whitespace-nowrap tracking-wide">üìû ${entry.captain.phone}</div>
                    </td>
                    <td class="px-4 py-4 align-middle min-w-[200px]">
                        ${membersHtml}
                    </td>
                    <td class="px-4 py-4 align-middle text-center">
                        ${entry.screenshotUrl ? 
                            `<a href="${entry.screenshotUrl}" target="_blank" class="inline-block p-1 border border-gray-700 rounded hover:border-[#c5a059] hover:bg-[#c5a059]/10 transition" title="View Parchment">
                                <span class="text-xl">üìÑ</span>
                            </a>` : 
                            `<span class="text-gray-700 text-lg" title="Missing">-</span>`
                        }
                    </td>
                    <td class="px-4 py-4 align-middle text-right min-w-[150px]">
                        ${actionButtons}
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update UI Stats
            statTeams.innerText = tTeams;
            statWizards.innerText = tWizards;
            statRevenue.innerText = `‚Çπ${tRevenue}`;
        }

        // --- Actions ---
        
        // 1. Set Status (DB Update)
        window.setStatus = async (key, status) => {
             try {
                await update(ref(db, `registrations/${key}`), { status: status });
                // Reload data to reflect changes
                await loadData();
            } catch(e) {
                console.error(e);
                showModal("Error", "The spell fizzled. Status not updated.");
            }
        };

        // 2. Compose Accept Email
        window.composeAcceptEmail = (email, team, captain) => {
            const subject = `Owl Post: Acceptance to Hogwarts Treasure Hunt`;
            const body = `Dear ${captain},\n\nWe are pleased to inform you that your team, "${team}", has been officially accepted for the Hogwarts Treasure Hunt.\n\n‚ö° IMPORTANT: You must join the official Order of the Phoenix (WhatsApp Group) to receive your Portkey location: https://chat.whatsapp.com/JcUZ4kd3v2l7Vn88BE8O60\n\nKeep your wand ready.\n\nRegards,\nTech Head J.S. Dingra\nSciRox - Science Club`;
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
        };

        // 3. Compose Reject Email
        window.composeRejectEmail = (email, team, captain) => {
            const subject = `Owl Post: Application Status for Hogwarts Treasure Hunt`;
            const body = `Dear ${captain},\n\nWe have reviewed your application for the team "${team}".\n\nUnfortunately, we cannot accept your registration at this time due to issues with the verification process (e.g. invalid payment screenshot).\n\nPlease reply to this owl or contact the organizers if you believe this is a mistake.\n\nRegards,\nTech Head J.S. Dingra\nSciRox - Science Club`;
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
        };

        // 4. Delete (Expel)
        window.triggerDelete = (key) => {
            deleteTargetKey = key;
            showModal(
                "Expel Student?", 
                "This action is irreversible (Avada Kedavra). The record will be permanently destroyed.", 
                true // showCancel
            );
        };

        async function confirmDelete() {
            if(!deleteTargetKey) return;
            try {
                await remove(ref(db, `registrations/${deleteTargetKey}`));
                // Remove row locally or reload
                await loadData();
                showModal("Success", "The record has been vanished.");
            } catch(e) {
                console.error(e);
                showModal("Error", "The spell backfired. Could not delete.");
            }
            deleteTargetKey = null;
        }


        // --- Modal System ---
        window.closeModal = () => modal.classList.add('hidden');
        window.showModal = (title, msg, showCancel = false) => {
            modalTitle.textContent = title;
            modalMessage.textContent = msg;
            
            if(showCancel) {
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.textContent = "Confirm Expulsion";
                modalConfirmBtn.onclick = () => { closeModal(); confirmDelete(); };
            } else {
                modalCancelBtn.classList.add('hidden');
                modalConfirmBtn.textContent = "Dissendium";
                modalConfirmBtn.onclick = closeModal;
            }
            
            modal.classList.remove('hidden');
        };

        initApp();
    </script>
</body>
</html>
