<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE DEATHLY HALLOWS | Hogwarts Treasure Hunt</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"></script>

    <style>
        :root {
            --magic-gold: #c5a059;
            --magic-blue: #74c7d5; /* Patronus color */
            --dark-bg: #050508;
            --parchment: #f0e6d2;
            --dementor-black: #000000;
            --glow-patronus: 0 0 15px #74c7d5, 0 0 30px #74c7d5, 0 0 50px #ffffff;
        }

        body {
            background-color: var(--dark-bg);
            color: #b0b0b0;
            font-family: 'Crimson Text', serif;
            overflow-x: hidden;
            cursor: none; /* Hide default cursor for Wand effect */
        }

        /* The Title Font styling */
        .title-font {
            font-family: 'Cinzel', serif;
            color: #e0e0e0;
            letter-spacing: 2px;
            text-shadow: 0 5px 15px rgba(0,0,0,0.8);
            background: linear-gradient(to bottom, #cfc7b8, #8a7e66);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .title-sub {
            font-family: 'Cinzel', serif;
            color: var(--magic-blue);
            text-shadow: 0 0 10px rgba(116, 199, 213, 0.5);
        }

        /* Atmosphere */
        #canvas-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
            background: radial-gradient(circle at center, #111118 0%, #000000 100%);
        }

        /* Rolling Dementor Fog */
        .fog-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        .fog-img {
            position: absolute;
            height: 100vh;
            width: 300vw;
            /* Icy blue filter for Dementor cold */
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVzPSJzdGl0Y2giLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWx0ZXI9InVybCgjbm9pc2UpIiBvcGFjaXR5PSIwLjMiLz48L3N2Zz4=');
            background-size: cover;
            opacity: 0.1;
            filter: sepia(1) hue-rotate(180deg) saturate(1.5); /* Blue tint */
            animation: fogFlow 60s linear infinite;
        }
        .fog-img-2 {
            animation: fogFlow 40s linear infinite reverse;
            opacity: 0.05;
            filter: sepia(1) hue-rotate(180deg) saturate(2);
        }

        @keyframes fogFlow {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-200vw, 0, 0); }
        }

        /* The Dementor */
        .dementor-wrapper {
            position: fixed;
            top: 10%;
            right: -10%; /* Start off screen */
            width: 300px;
            height: 500px;
            z-index: 2;
            pointer-events: none;
            opacity: 0.8;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.9));
            animation: floatDementor 20s ease-in-out infinite;
        }

        @keyframes floatDementor {
            0% { transform: translate(0, 0) rotate(5deg); opacity: 0; }
            10% { opacity: 0.8; }
            50% { transform: translate(-40vw, 50px) rotate(-5deg); }
            90% { opacity: 0.8; }
            100% { transform: translate(-120vw, 0) rotate(5deg); opacity: 0; }
        }
        
        /* Cloth ripple effect */
        .cloak-piece {
            transform-origin: top center;
            animation: clothWave 3s ease-in-out infinite alternate;
        }
        @keyframes clothWave {
            0% { transform: rotate(-2deg); }
            100% { transform: rotate(2deg); }
        }

        /* Devil's Snare (Re-styled vines) */
        .vine-base {
            position: fixed;
            width: 300px;
            height: 300px;
            z-index: 40;
            pointer-events: none;
            background-repeat: no-repeat;
            filter: brightness(0.2) sepia(1) hue-rotate(70deg) saturate(0.5) drop-shadow(0 0 5px #000); /* Dark green/black */
            opacity: 0.6;
        }

        /* Vine Shape SVG */
        .vine-shape {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 100C50 100 60 60 30 50C0 40 20 10 20 10' stroke='%233a4a3a' stroke-width='8' stroke-linecap='round'/%3E%3Cpath d='M50 100C50 100 40 70 70 60C100 50 80 10 80 10' stroke='%232a3a2a' stroke-width='6' stroke-linecap='round'/%3E%3Cpath d='M55 90C55 90 85 85 90 50' stroke='%231a2a1a' stroke-width='4'/%3E%3C/svg%3E");
            background-size: contain;
        }

        /* Input Fields */
        .input-field {
            background: rgba(10, 15, 20, 0.7);
            border: 1px solid #2f3e46;
            color: #e0e0e0;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--magic-blue);
            box-shadow: 0 0 10px rgba(116, 199, 213, 0.2);
        }

        /* Buttons */
        .btn-magic {
            background: linear-gradient(45deg, #0f1c25, #1a2a35);
            border: 1px solid var(--magic-gold);
            color: var(--magic-gold);
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            transition: all 0.5s;
        }

        .btn-magic:hover {
            background: linear-gradient(45deg, #1a2a35, #2c3e50);
            box-shadow: 0 0 15px rgba(197, 160, 89, 0.3);
            text-shadow: 0 0 5px var(--magic-gold);
        }

        /* Loader */
        .loader {
            border: 3px solid rgba(116, 199, 213, 0.1);
            border-left-color: var(--magic-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
            filter: drop-shadow(0 0 5px var(--magic-blue));
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Lumos Wand Effect (Replaces Flashlight) */
        .lumos-cursor {
            position: fixed;
            top: 0; left: 0;
            width: 300px; height: 300px;
            pointer-events: none;
            z-index: 100;
            background: radial-gradient(circle closest-side, rgba(255,255,255,0.8) 0%, rgba(116,199,213,0.4) 20%, transparent 70%);
            transform: translate(-50%, -50%);
            mix-blend-mode: screen;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        /* Wand Tip Spark */
        .wand-tip {
            position: fixed;
            width: 8px; height: 8px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 101;
            box-shadow: 0 0 10px #fff, 0 0 20px var(--magic-blue), 0 0 40px var(--magic-blue);
            transform: translate(-50%, -50%);
        }

        /* Content Container */
        .glass-panel {
            background: rgba(5, 5, 8, 0.65);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(116, 199, 213, 0.1);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center">

    <!-- Backgrounds & Effects -->
    <div id="canvas-container"><canvas id="soul-wisps"></canvas></div>
    
    <!-- Mist Layers -->
    <div class="fog-container">
        <div class="fog-img"></div>
        <div class="fog-img-2"></div>
    </div>

    <!-- Devil's Snare (Static Corners) -->
    <div class="vine-base vine-shape" style="top: -50px; left: -50px; transform: rotate(135deg);"></div>
    <div class="vine-base vine-shape" style="top: -50px; right: -50px; transform: rotate(-135deg);"></div>
    <div class="vine-base vine-shape" style="bottom: -50px; left: -50px; transform: rotate(45deg);"></div>
    <div class="vine-base vine-shape" style="bottom: -50px; right: -50px; transform: rotate(-45deg);"></div>
    
    <!-- Dynamic Devil's Snare Container -->
    <div id="dynamic-vines"></div>

    <!-- The Dementor (Floating Animation) -->
    <div id="dementor" class="dementor-wrapper">
        <svg viewBox="0 0 200 400" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <filter id="blurFilter">
                    <feGaussianBlur in="SourceGraphic" stdDeviation="2" />
                </filter>
            </defs>
            <!-- Cloak Body -->
            <path class="cloak-piece" d="M100,50 Q140,50 150,100 Q170,200 160,350 Q130,380 100,340 Q70,380 40,350 Q30,200 50,100 Q60,50 100,50 Z" fill="#0a0a0a" opacity="0.9" />
            
            <!-- Tattered Ends -->
            <path d="M40,350 L30,400 L50,360 L60,390 L80,350" fill="#0a0a0a" opacity="0.8" />
            <path d="M160,350 L170,400 L150,360 L140,390 L120,350" fill="#0a0a0a" opacity="0.8" />
            
            <!-- Hood/Head -->
            <path d="M100,30 Q130,30 135,70 Q130,90 100,85 Q70,90 65,70 Q70,30 100,30 Z" fill="#000" />
            <!-- The "Mouth" Void -->
            <ellipse cx="100" cy="75" rx="10" ry="15" fill="#1a1a1a" filter="url(#blurFilter)" />
            
            <!-- Skeletal Hand -->
            <path d="M150,150 L170,140 L165,160" stroke="#333" stroke-width="2" fill="none"/>
        </svg>
    </div>

    <!-- Lumos Effect -->
    <div class="lumos-cursor" id="lumos-glow"></div>
    <div class="wand-tip" id="wand-tip"></div>

    <!-- Main Container -->
    <main class="relative z-50 w-full max-w-4xl p-6 mx-auto">
        
        <!-- Header / Logo -->
        <header class="text-center mb-12 animate-fade-in-down">
            <h2 class="text-gray-500 tracking-[0.5em] text-xs uppercase mb-4 font-serif">Ministry of Magic ‚Ä¢ Department of Mysteries</h2>
            <div class="relative inline-block">
                <h1 class="text-5xl md:text-7xl font-bold uppercase title-font mb-4">
                    The Dark Mark
                </h1>
                <!-- Separator -->
                <div class="flex items-center justify-center gap-4 mb-8">
                    <div class="h-[1px] w-24 bg-gradient-to-r from-transparent to-[#c5a059]"></div>
                    <span class="text-[#c5a059] text-xl">‚ö°</span>
                    <div class="h-[1px] w-24 bg-gradient-to-l from-transparent to-[#c5a059]"></div>
                </div>
            </div>
            <p class="text-gray-400 max-w-lg mx-auto text-lg leading-relaxed font-serif italic">
                "Happiness can be found, even in the darkest of times, if one only remembers to turn on the light."
            </p>
        </header>

        <!-- Dynamic Content Area -->
        <div id="app-content" class="glass-panel p-10 rounded-sm relative overflow-hidden mb-12">
            
            <!-- Loading State -->
            <div id="loading-screen" class="flex flex-col items-center justify-center py-12">
                <div class="loader mb-6"></div>
                <p class="text-cyan-100 animate-pulse font-serif tracking-widest">Consulting the Sorting Hat...</p>
            </div>

            <!-- Registration Form -->
            <div id="registration-view" class="hidden">
                <h3 class="text-2xl text-[#c5a059] mb-8 text-center font-bold border-b border-[#c5a059]/30 pb-4 font-serif uppercase tracking-widest">W.O.M.B.A.T. Registration</h3>
                <form id="reg-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-500 text-xs mb-2 uppercase tracking-widest">House / Team Name</label>
                            <input type="text" id="teamName" required class="w-full p-3 rounded-sm input-field" placeholder="e.g. Dumbledore's Army">
                        </div>
                        <div>
                            <label class="block text-gray-500 text-xs mb-2 uppercase tracking-widest">Head of House (Captain)</label>
                            <input type="text" id="captainName" required class="w-full p-3 rounded-sm input-field" placeholder="e.g. Hermione Granger">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-500 text-xs mb-2 uppercase tracking-widest">Owl Post (Email)</label>
                        <input type="email" id="email" required class="w-full p-3 rounded-sm input-field" placeholder="wizard@hogwarts.edu">
                    </div>

                    <div>
                        <label class="block text-gray-500 text-xs mb-2 uppercase tracking-widest">Party Size (Max 3)</label>
                        <select id="teamSize" class="w-full p-3 rounded-sm input-field">
                            <option value="1">Solo Wizard (1)</option>
                            <option value="2">Dynamic Duo (2)</option>
                            <option value="3">Golden Trio (3)</option>
                        </select>
                    </div>

                    <div class="pt-6">
                        <button type="submit" class="w-full py-4 text-xl font-bold btn-magic group rounded-sm">
                            <span class="group-hover:hidden">Enter the Forbidden Forest</span>
                            <span class="hidden group-hover:block">Expecto Patronum!</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Dashboard / Game Start -->
            <div id="dashboard-view" class="hidden text-center">
                <div class="mb-8">
                    <h3 class="text-3xl text-[#c5a059] font-serif mb-2">Welcome, <span id="user-team-name" class="text-white">Student</span></h3>
                    <p class="text-gray-400 font-serif italic">Status: <span class="text-green-400">Enrolled</span> | ID: <span id="user-id-display" class="font-mono text-xs text-gray-600"></span></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div class="bg-black/40 border border-[#c5a059]/20 p-4 rounded-sm">
                        <h4 class="text-gray-500 uppercase text-xs tracking-widest mb-2">Current Quest</h4>
                        <p class="text-lg text-white font-serif">Await the Headmaster's Speech</p>
                    </div>
                    <div class="bg-black/40 border border-[#c5a059]/20 p-4 rounded-sm">
                        <h4 class="text-gray-500 uppercase text-xs tracking-widest mb-2">Time Until Curfew</h4>
                        <p id="countdown" class="text-2xl font-serif text-[#c5a059]">00:00:00</p>
                    </div>
                </div>

                <div class="border-t border-[#c5a059]/20 pt-8">
                    <p class="mb-4 text-sm text-gray-500 italic">The Marauder's Map will reveal the first clue shortly.</p>
                    <div class="p-8 bg-[#0a0a0a] border border-dashed border-[#c5a059]/40 rounded-sm relative">
                        <p class="text-[#c5a059] font-mono text-xs uppercase animate-pulse">Mischief Managed...</p>
                        <div class="mt-4 text-4xl text-[#333]">? ? ?</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- NEW SECTION: Classified Dossier (Rules, Rounds, Organizers) -->
        <div id="classified-dossier" class="max-w-4xl mx-auto space-y-8 animate-fade-in-up mb-12">
            
            <!-- Section Header -->
            <div class="text-center border-b border-[#c5a059]/30 pb-4">
                <h3 class="text-2xl font-bold text-[#c5a059] uppercase tracking-widest font-serif">Tournament Rules</h3>
                <p class="text-gray-600 text-xs font-serif mt-1">PER ORDER OF DOLORES UMBRIDGE</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- Card 1: Protocols (Rules) -->
                <div class="bg-black/60 border border-[#c5a059]/20 p-6 rounded-sm hover:border-[#c5a059] transition-colors duration-300">
                    <h4 class="text-xl text-gray-300 font-serif mb-4 uppercase flex items-center gap-2">
                        <span class="text-[#c5a059]">üìú</span> Decrees
                    </h4>
                    <ul class="text-sm text-gray-400 space-y-3 font-serif list-disc pl-4">
                        <li><strong class="text-gray-300">No Muggles:</strong> Magic use only. No AI engines or external help.</li>
                        <li><strong class="text-gray-300">Time-Turners:</strong> Strictly forbidden. When time is up, it is up.</li>
                        <li><strong class="text-gray-300">Forbidden Forest:</strong> Stay within the designated castle grounds.</li>
                        <li><strong class="text-gray-300">Prefects:</strong> The word of the organizers is final law.</li>
                    </ul>
                </div>

                <!-- Card 2: Stages (Rounds) -->
                <div class="bg-black/60 border border-[#c5a059]/20 p-6 rounded-sm hover:border-[#c5a059] transition-colors duration-300">
                    <h4 class="text-xl text-gray-300 font-serif mb-4 uppercase flex items-center gap-2">
                        <span class="text-[#c5a059]">üèÜ</span> Triwizard Tasks
                    </h4>
                    <div class="space-y-4 text-sm font-serif text-gray-400">
                        <div class="border-l-2 border-[#c5a059] pl-3">
                            <p class="text-[#c5a059] font-bold text-xs uppercase">Task 01</p>
                            <p class="text-white">Ancient Runes</p>
                            <p class="text-xs mt-1">Decipher the riddles to find the portkey.</p>
                        </div>
                        <div class="border-l-2 border-[#c5a059] pl-3">
                            <p class="text-[#c5a059] font-bold text-xs uppercase">Task 02</p>
                            <p class="text-white">The Hunt</p>
                            <p class="text-xs mt-1">Physical search for Horcruxes hidden in the venue.</p>
                        </div>
                        <div class="border-l-2 border-[#c5a059] pl-3">
                            <p class="text-[#c5a059] font-bold text-xs uppercase">Final Task</p>
                            <p class="text-white">The Maze</p>
                            <p class="text-xs mt-1">The final duel for the House Cup.</p>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Agency (Organizers) -->
                <div class="bg-black/60 border border-[#c5a059]/20 p-6 rounded-sm hover:border-[#c5a059] transition-colors duration-300 flex flex-col justify-between">
                    <div>
                        <h4 class="text-xl text-gray-300 font-serif mb-4 uppercase flex items-center gap-2">
                            <span class="text-[#c5a059]">‚öñÔ∏è</span> Ministry
                        </h4>
                        <p class="text-sm text-gray-400 font-serif leading-relaxed mb-4">
                            This event is authorized by the <strong class="text-white">SCIROX</strong> Club of Witchcraft and Wizardry. 
                        </p>
                        <p class="text-xs text-gray-600 font-serif italic">
                            Report all Dark Mark sightings immediately.
                        </p>
                    </div>
                    <div class="mt-6 text-center pt-6 border-t border-dashed border-[#c5a059]/30">
                        <span class="text-2xl font-bold tracking-widest text-[#c5a059] block font-serif">SCIROX</span>
                        <span class="text-[10px] uppercase tracking-[0.3em] text-gray-500">Headmasters</span>
                    </div>
                </div>

            </div>
        </div>

        <footer class="mt-12 text-center text-gray-700 text-xs font-serif">
            <p>&copy; 2026 SCIROX x Ministry of Magic. All rights reserved.</p>
            <p class="mt-2">Draco Dormiens Nunquam Titillandus.</p>
        </footer>

    </main>

    <!-- Modal for Messages -->
    <div id="modal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-[#111] border border-[#c5a059] p-8 max-w-md w-full text-center rounded-sm shadow-[0_0_30px_rgba(197,160,89,0.2)]">
            <h3 id="modal-title" class="text-2xl text-[#c5a059] font-bold mb-4 font-serif">Message from Dumbledore</h3>
            <p id="modal-message" class="text-gray-400 mb-8 font-serif">Something went wrong.</p>
            <button onclick="closeModal()" class="px-6 py-2 btn-magic w-full rounded-sm">Dissendium</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase Functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- UI References ---
        const loadingScreen = document.getElementById('loading-screen');
        const registrationView = document.getElementById('registration-view');
        const dashboardView = document.getElementById('dashboard-view');
        const regForm = document.getElementById('reg-form');
        const userTeamNameDisplay = document.getElementById('user-team-name');
        const userIdDisplay = document.getElementById('user-id-display');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        // --- Global Functions ---
        window.closeModal = () => {
            if (modal) modal.classList.add('hidden');
        };

        const showModal = (title, msg) => {
            if (modalTitle) modalTitle.textContent = title;
            if (modalMessage) modalMessage.textContent = msg;
            if (modal) modal.classList.remove('hidden');
        };

        const switchView = (viewId) => {
            if(loadingScreen) loadingScreen.classList.add('hidden');
            if(registrationView) registrationView.classList.add('hidden');
            if(dashboardView) dashboardView.classList.add('hidden');
            const target = document.getElementById(viewId);
            if(target) target.classList.remove('hidden');
        };

        let app, auth, db, currentUser = null;

        // --- Safe Initialization ---
        async function initApp() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
                    authDomain: "iist-fd6e8.firebaseapp.com",
                    databaseURL: "https://iist-fd6e8-default-rtdb.firebaseio.com",
                    projectId: "iist-fd6e8",
                    storageBucket: "iist-fd6e8.firebasestorage.app",
                    messagingSenderId: "692699808449",
                    appId: "1:692699808449:web:120c8941a940d071f24a40"
                };

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app); 

                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if (user) {
                        await checkRegistration(user.uid);
                    }
                });

                spawnVines();

            } catch (error) {
                console.error("Initialization Error:", error);
                showModal("Owl Post Failed", "Could not connect to the Ministry Network. (Check Console)");
                if(loadingScreen) loadingScreen.innerHTML = `<p class="text-red-500">Connection Failed.</p>`;
            }
        }

        const checkRegistration = async (uid) => {
            if (!db) return;
            try {
                const registrationsRef = ref(db, 'registrations');
                const userQuery = query(registrationsRef, orderByChild('uid'), equalTo(uid));
                
                onValue(userQuery, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = Object.values(snapshot.val())[0];
                        if(userTeamNameDisplay) userTeamNameDisplay.textContent = data.teamName;
                        if(userIdDisplay) userIdDisplay.textContent = uid;
                        switchView('dashboard-view');
                    } else {
                        switchView('registration-view');
                    }
                }, (error) => {
                    console.error("Realtime DB error:", error);
                    switchView('registration-view'); 
                });

            } catch (e) {
                console.error("Query Error", e);
                switchView('registration-view');
            }
        };

        if (regForm) {
            regForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentUser || !db) {
                    showModal("Error", "No magic detected. Refresh page.");
                    return;
                }

                const teamName = document.getElementById('teamName').value;
                const captainName = document.getElementById('captainName').value;
                const email = document.getElementById('email').value;
                const teamSize = document.getElementById('teamSize').value;

                const submitBtn = regForm.querySelector('button');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = "Sending Owl...";
                submitBtn.disabled = true;

                try {
                    const newRegRef = push(ref(db, 'registrations'));
                    await set(newRegRef, {
                        uid: currentUser.uid,
                        teamName,
                        captainName,
                        email,
                        teamSize,
                        timestamp: new Date().toISOString()
                    });
                    
                } catch (error) {
                    console.error("Registration failed:", error);
                    showModal("Spell Failed", "The Dementors intercepted your request. Try again.");
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                }
            });
        }

        // --- Visual Effects Logic ---
        
        // 1. Soul Wisps (Replaces Spores)
        const canvas = document.getElementById('soul-wisps');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];

            function resize() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
            }

            class Particle {
                constructor() {
                    this.reset();
                }
                reset() {
                    this.x = Math.random() * width;
                    this.y = height + Math.random() * 100; // Start from bottom
                    this.vx = (Math.random() - 0.5) * 1;
                    this.vy = (Math.random() * -1) - 0.5; // Float up
                    this.size = Math.random() * 2 + 0.5; 
                    this.alpha = Math.random() * 0.5 + 0.1;
                    this.life = Math.random() * 200 + 100;
                }
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.life--;
                    
                    // Wisp movement
                    this.vx += (Math.random() - 0.5) * 0.05;

                    if (this.life <= 0 || this.y < -50) {
                        this.reset();
                    }
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    // Icy blue color
                    ctx.fillStyle = `rgba(174, 216, 230, ${this.alpha})`;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = "rgba(116, 199, 213, 0.8)";
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            }

            function initParticles() {
                particles = [];
                for (let i = 0; i < 100; i++) {
                    particles.push(new Particle());
                }
            }

            function animateParticles() {
                if (!width || !height) return requestAnimationFrame(animateParticles);
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                requestAnimationFrame(animateParticles);
            }

            window.addEventListener('resize', resize);
            resize();
            initParticles();
            animateParticles();
        }

        // 2. Lumos Wand Effect
        const lumosGlow = document.getElementById('lumos-glow');
        const wandTip = document.getElementById('wand-tip');
        
        if (lumosGlow && wandTip) {
            document.addEventListener('mousemove', (e) => {
                const x = e.clientX;
                const y = e.clientY;
                
                // Tip follows strictly
                wandTip.style.left = x + 'px';
                wandTip.style.top = y + 'px';

                // Glow follows with slight lag/smoothness (CSS transition handles opacity)
                lumosGlow.style.left = x + 'px';
                lumosGlow.style.top = y + 'px';
            });
        }

        // 3. Simple Countdown
        function startCountdown() {
            const el = document.getElementById('countdown');
            if (!el) return;
            let timeLeft = 24 * 60 * 60; 
            setInterval(() => {
                timeLeft--;
                const h = Math.floor(timeLeft / 3600);
                const m = Math.floor((timeLeft % 3600) / 60);
                const s = timeLeft % 60;
                el.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }
        startCountdown();

        // 4. Dynamic Devil's Snare
        function spawnVines() {
            const container = document.getElementById('dynamic-vines');
            if (!container) return;
            const vineCount = 15; 
            
            const addVine = (x, y, r, s, op) => {
                const el = document.createElement('div');
                el.className = 'vine-base vine-shape';
                el.style.left = x;
                el.style.top = y;
                el.style.transform = `rotate(${r}deg) scale(${s})`;
                el.style.opacity = op;
                container.appendChild(el);
            };

            for(let i=0; i<vineCount; i++) {
                const x = Math.random() * 100 + '%';
                const y = Math.random() * 100 + '%';
                const r = Math.random() * 360;
                const s = Math.random() * 0.4 + 0.3;
                addVine(x, y, r, s, 0.4);
            }
        }

        initApp();

    </script>
</body>
</html>
