<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic AGN & Star Formation Simulation</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            backdrop-filter: blur(5px);
        }
        h1 {
            font-size: 1.2rem;
            margin: 0 0 10px 0;
            color: #4facfe;
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }
        p {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #ccc;
            margin-bottom: 15px;
        }
        .indicator {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
        }
        #status-box {
            margin-top: 15px;
            padding: 12px;
            background: rgba(20, 20, 30, 0.8);
            border-radius: 4px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            border-left: 4px solid #4facfe;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #restart-btn {
            pointer-events: auto;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border: none;
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
            width: 100%;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            transition: transform 0.1s;
        }
        #restart-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.6);
        }
        #stats {
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #888;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>Astrophysical Simulation</h1>
        <p>Simulating the co-evolution of a galaxy and its Supermassive Black Hole using Keplerian dynamics and viscous accretion.</p>
        
        <div class="indicator"><span class="dot" style="background: #a54;"></span> Molecular Gas (Cold)</div>
        <div class="indicator"><span class="dot" style="background: #fff; box-shadow: 0 0 5px #fff;"></span> Young Stars (Blue/White)</div>
        <div class="indicator"><span class="dot" style="background: #fc0; box-shadow: 0 0 8px #fc0;"></span> Active Nucleus (Accretion)</div>
        <div class="indicator"><span class="dot" style="background: #f0f; box-shadow: 0 0 5px #f0f;"></span> Relativistic Jets</div>

        <div id="status-box">Initializing Gravitational Field...</div>
        <div id="stats">
            Velocity: <span id="vel-disp">0</span> km/s<br>
            Accretion Rate: <span id="acc-rate">0</span> Mâ˜‰/yr
        </div>
        <button id="restart-btn">Reset Simulation</button>
    </div>

    <div id="canvas-container"></div>

    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- Astrophysical Constants (Scaled) ---
        const G_MASS = 2000;         // Central mass parameter (GM)
        const DISC_SCALE = 60;       // Scale of the galaxy
        const NUM_PARTICLES = 20000;
        const NUM_JET_PARTICLES = 2000;
        const SPIRAL_ARMS = 2;
        const ARM_WINDING = 0.5;     // How tight the spiral is
        const VISCOSITY = 0.025;     // INCREASED: Gas flows to center much faster
        const AGN_CRITICAL_MASS = 500; // LOWERED: Easier to trigger ignition
        const AGN_SHUTDOWN_MASS = 1500; // Mass at which AGN consumes all fuel/quenches
        const STAR_FORMATION_THRESH = 0.03; // LOWERED: Slightly less gas lost to stars
        
        // --- System State ---
        let scene, camera, renderer;
        let galaxyGeo, galaxyMat, galaxyPoints;
        let jetGeo, jetMat, jetPoints;
        let agnCore, agnGlow;
        let particlesData = []; // Store physics state per particle
        let jetData = [];
        let agnActive = false;
        let currentPhase = 1;
        let agnMass = 0;
        let time = 0;

        // Particle Types
        const TYPE_GAS = 0;
        const TYPE_STAR = 1;
        const TYPE_DEAD = 2;

        function init() {
            const container = document.getElementById('canvas-container');
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for performance
            container.appendChild(renderer.domElement);

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020205); // Deep space
            scene.fog = new THREE.FogExp2(0x020205, 0.008);

            // Camera
            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 50, 80);
            camera.lookAt(0, 0, 0);

            // --- Generate Galaxy ---
            createGalaxy();
            createJets();
            createAGN();

            // Lights
            const ambientLight = new THREE.AmbientLight(0x111111);
            scene.add(ambientLight);

            // Listeners
            window.addEventListener('resize', onResize);
            document.addEventListener('mousemove', onMouseMove);
            document.getElementById('restart-btn').addEventListener('click', resetSimulation);

            animate();
        }

        function createGalaxy() {
            galaxyGeo = new THREE.BufferGeometry();
            const positions = new Float32Array(NUM_PARTICLES * 3);
            const colors = new Float32Array(NUM_PARTICLES * 3);
            const sizes = new Float32Array(NUM_PARTICLES);

            particlesData = [];

            const colorGas = new THREE.Color(0x884444); // Dusty red

            for(let i=0; i<NUM_PARTICLES; i++) {
                // Initialize physics state
                const r = 5 + Math.random() * DISC_SCALE; // Avoid singularity at r=0
                // Logarithmic spiral distribution for initial visual seed, but physics will take over
                const angleOffset = (Math.random() * Math.PI * 2); 
                
                // Physics object
                particlesData.push({
                    r: r,
                    theta: angleOffset,
                    y: (Math.random() - 0.5) * (r * 0.05), // Flatter at edges
                    vRadial: 0,
                    vTheta: Math.sqrt(G_MASS / r), // Keplerian Velocity v = sqrt(GM/r)
                    type: TYPE_GAS,
                    age: 0,
                    baseSize: Math.random() * 0.5 + 0.2
                });

                // Set buffers
                positions[i*3] = Math.cos(angleOffset) * r;
                positions[i*3+1] = particlesData[i].y;
                positions[i*3+2] = Math.sin(angleOffset) * r;

                colors[i*3] = colorGas.r;
                colors[i*3+1] = colorGas.g;
                colors[i*3+2] = colorGas.b;

                sizes[i] = particlesData[i].baseSize;
            }

            galaxyGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            galaxyGeo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            galaxyGeo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // Texture
            const sprite = generateSprite();
            
            galaxyMat = new THREE.PointsMaterial({
                size: 1,
                map: sprite,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true,
                opacity: 0.8
            });

            galaxyPoints = new THREE.Points(galaxyGeo, galaxyMat);
            scene.add(galaxyPoints);
        }

        function createJets() {
            jetGeo = new THREE.BufferGeometry();
            const positions = new Float32Array(NUM_JET_PARTICLES * 3);
            const colors = new Float32Array(NUM_JET_PARTICLES * 3);
            
            jetData = [];
            for(let i=0; i<NUM_JET_PARTICLES; i++) {
                jetData.push({
                    life: 0,
                    speed: 0,
                    dir: 1, // 1 for up, -1 for down
                    active: false
                });
                positions[i*3] = 0; positions[i*3+1] = 0; positions[i*3+2] = 0;
                colors[i*3] = 0.5; colors[i*3+1] = 0.8; colors[i*3+2] = 1.0;
            }

            jetGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            jetGeo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            jetMat = new THREE.PointsMaterial({
                size: 2.0,
                map: generateSprite(),
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true
            });

            jetPoints = new THREE.Points(jetGeo, jetMat);
            scene.add(jetPoints);
        }

        function createAGN() {
            const geometry = new THREE.SphereGeometry(1.5, 32, 32);
            const material = new THREE.MeshBasicMaterial({ color: 0x000000 });
            agnCore = new THREE.Mesh(geometry, material);
            scene.add(agnCore);

            const glowGeo = new THREE.SpriteMaterial({ 
                map: generateSprite(), 
                color: 0xffaa00, 
                blending: THREE.AdditiveBlending 
            });
            agnGlow = new THREE.Sprite(glowGeo);
            agnGlow.scale.set(10, 10, 1);
            agnCore.add(agnGlow);
            agnCore.visible = false; // Hidden until triggered
        }

        function generateSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(0.4, 'rgba(255,255,255,0.2)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(canvas);
        }

        // --- Physics Engine ---

        function updateGalaxy(dt) {
            const positions = galaxyGeo.attributes.position.array;
            const colors = galaxyGeo.attributes.color.array;
            const sizes = galaxyGeo.attributes.size.array;
            
            let accretionCount = 0;
            let starFormationRate = 0;

            // Phase 1 -> 2 Transition Logic (Time-based for demonstration)
            if (currentPhase === 1 && time > 3.0) {
                currentPhase = 2;
                updateStatusBox(2);
            }

            // Pre-calculate spiral potential for density waves
            // This represents the rotating gravitational potential of spiral arms
            const armSpeed = 1.5; // Pattern speed
            const armPhase = time * armSpeed * 0.1;

            for(let i=0; i<NUM_PARTICLES; i++) {
                const p = particlesData[i];
                if(p.type === TYPE_DEAD) {
                    // Respawn logic ONLY if not in Quenched phase
                    if(currentPhase < 4 && Math.random() < 0.001) {
                         p.type = TYPE_GAS;
                         p.r = DISC_SCALE;
                         p.theta = Math.random() * Math.PI * 2;
                         p.vTheta = Math.sqrt(G_MASS/p.r);
                         p.age = 0;
                         sizes[i] = p.baseSize;
                         colors[i*3] = 0.5; colors[i*3+1] = 0.2; colors[i*3+2] = 0.2;
                    }
                    positions[i*3] = 9999; 
                    continue;
                }

                // 1. Gravity & Keplerian Motion
                // v = sqrt(GM/r). Angular velocity omega = v/r = sqrt(GM)/r^1.5
                const omega = Math.sqrt(G_MASS) / Math.pow(p.r, 1.5);
                p.theta += omega * dt;

                // 2. Viscous Accretion (Inflow)
                // Gas loses angular momentum and drifts inward
                if (p.type === TYPE_GAS) {
                    p.r -= VISCOSITY * (10/p.r) * dt; 
                }

                // 3. Spiral Arm Interaction (Density Wave)
                // Mathematical def of logarithmic spiral: theta = ln(r)/tan(alpha)
                // We check if particle is crossing an arm
                const spiralTheta = (Math.log(p.r/5) / Math.tan(ARM_WINDING)) + armPhase;
                // Normalize angles
                let angleDiff = (p.theta - spiralTheta) % (Math.PI); 
                if (angleDiff < 0) angleDiff += Math.PI;
                
                // Shock detection: If close to arm phase
                const inArm = (angleDiff < 0.3);

                // 4. Star Formation Physics
                // If Gas + In Arm + Random Chance -> Collapse to Star
                // ONLY allow star formation in phases 2 and 3
                if (p.type === TYPE_GAS && inArm && currentPhase >= 2 && currentPhase < 4) {
                    if (Math.random() < STAR_FORMATION_THRESH * dt) {
                        p.type = TYPE_STAR;
                        p.age = 0;
                        // Initial Blue Burst
                        colors[i*3] = 0.7; colors[i*3+1] = 0.8; colors[i*3+2] = 1.0;
                        sizes[i] = p.baseSize * 3.0; // Bloom effect
                    }
                }

                // 5. Star Evolution
                if (p.type === TYPE_STAR) {
                    starFormationRate++;
                    p.age += dt;
                    // Color evolution: Blue -> White -> Yellow -> Red -> Fade
                    const lifeRatio = p.age / 10.0; // Lifetime
                    
                    if (lifeRatio < 0.2) {
                        sizes[i] *= 0.98; // Shrink after birth
                    } else if (lifeRatio < 0.5) {
                        // Main sequence (yellowish)
                        colors[i*3] = 1.0; colors[i*3+1] = 0.9; colors[i*3+2] = 0.7;
                    } else {
                        // Old red giant / fade
                        colors[i*3] = 0.8; colors[i*3+1] = 0.4; colors[i*3+2] = 0.2;
                        sizes[i] *= 0.99;
                    }
                    
                    if (sizes[i] < 0.05) p.type = TYPE_DEAD; // Star death
                }

                // 6. AGN Feedback (Quasar Wind)
                // If AGN is active, it exerts pressure r^-2 outward
                if (agnActive && p.r < 30 && p.type === TYPE_GAS) {
                     p.r += 0.8 * dt; // Stronger push (Feedback Mode)
                     // Heat up pushed gas
                     colors[i*3] = 1.0; colors[i*3+1] = 0.5; colors[i*3+2] = 0.0;
                     // Slight chance to destroy/ionize gas completely
                     if(Math.random() < 0.01) p.type = TYPE_DEAD;
                }

                // 7. Accretion onto Black Hole
                if (p.r < 2) {
                    p.type = TYPE_DEAD;
                    agnMass++;
                    accretionCount++;
                }

                // Update Position Buffer
                positions[i*3] = Math.cos(p.theta) * p.r;
                positions[i*3+1] = p.y;
                positions[i*3+2] = Math.sin(p.theta) * p.r;
            }

            galaxyGeo.attributes.position.needsUpdate = true;
            galaxyGeo.attributes.color.needsUpdate = true;
            galaxyGeo.attributes.size.needsUpdate = true;

            // --- Logic Update ---
            // Trigger AGN (Phase 3)
            // Added OR condition: if time > 15, force trigger so simulation doesn't stick
            if (!agnActive && currentPhase < 4 && (agnMass > AGN_CRITICAL_MASS || (currentPhase === 2 && time > 15.0))) {
                activateAGN();
            }

            // Trigger Quenching (Phase 4)
            // Added OR condition: if time > 35, force shutdown
            if (agnActive && (agnMass > AGN_SHUTDOWN_MASS || time > 35.0)) {
                shutdownAGN();
            }

            // UI Data
            if (Math.random() > 0.9) { // Don't update DOM every frame
                 document.getElementById('acc-rate').innerText = (accretionCount * 10).toFixed(0);
                 // Estimate velocity at r=10
                 const v = Math.sqrt(G_MASS/10).toFixed(0);
                 document.getElementById('vel-disp').innerText = v;
            }
        }

        function updateJets(dt) {
            // Jets only exist if AGN is active OR (in phase 4 they fade out)
            if (!agnActive && currentPhase !== 4) return;
            
            // If phase 4, stop spawning, let existing fade
            const spawning = agnActive; 

            const positions = jetGeo.attributes.position.array;
            const colors = jetGeo.attributes.color.array;
            
            // Pulse intensity
            if (agnActive) {
                const intensity = 1 + Math.sin(time * 20) * 0.2;
                agnGlow.material.opacity = 0.8 + Math.random() * 0.2;
                agnGlow.scale.set(8 * intensity, 8 * intensity, 1);
            } else {
                agnGlow.material.opacity *= 0.95; // Fade out
            }

            for(let i=0; i<NUM_JET_PARTICLES; i++) {
                const p = jetData[i];

                if (!p.active) {
                    // Spawn new jet particle from center
                    if (spawning && Math.random() < 0.1) {
                        p.active = true;
                        p.life = 0;
                        p.dir = Math.random() > 0.5 ? 1 : -1;
                        p.speed = 15 + Math.random() * 5; // High velocity
                        
                        // Start at center
                        positions[i*3] = (Math.random()-0.5) * 0.5;
                        positions[i*3+1] = 0;
                        positions[i*3+2] = (Math.random()-0.5) * 0.5;
                    }
                    // Hide inactive
                    if(!p.active) positions[i*3+1] = 9999;
                    continue;
                }

                // Physics: Relativistic motion outward
                // Collimation: Keep x/z tight (magnetic confinement simulation)
                p.life += dt;
                
                // Move along Y
                positions[i*3+1] += p.speed * p.dir * dt;
                
                // Slight expansion (conical jet)
                const expansion = 1 + positions[i*3+1] * 0.05;
                positions[i*3] *= 1.01; 
                positions[i*3+2] *= 1.01;

                // Color cooling (Blue -> Purple -> Red)
                if (p.life < 0.5) {
                    colors[i*3] = 0.5; colors[i*3+1] = 0.8; colors[i*3+2] = 1.0;
                } else if (p.life < 1.0) {
                     colors[i*3] = 0.8; colors[i*3+1] = 0.0; colors[i*3+2] = 1.0;
                } else {
                     colors[i*3] = 0.4; colors[i*3+1] = 0.0; colors[i*3+2] = 0.1;
                }

                // Reset if too far
                if (Math.abs(positions[i*3+1]) > 60) {
                    p.active = false;
                }
            }
            jetGeo.attributes.position.needsUpdate = true;
            jetGeo.attributes.color.needsUpdate = true;
        }

        function activateAGN() {
            agnActive = true;
            currentPhase = 3;
            agnCore.visible = true;
            updateStatusBox(3);
        }

        function shutdownAGN() {
            agnActive = false;
            currentPhase = 4;
            // updateStatusBox handled below
            updateStatusBox(4);
        }

        // --- Interaction ---
        let mouseX = 0, mouseY = 0;
        function onMouseMove(e) {
            mouseX = (e.clientX - window.innerWidth/2) * 0.001;
            mouseY = (e.clientY - window.innerHeight/2) * 0.001;
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function updateStatusBox(phase) {
            const box = document.getElementById('status-box');
            if (phase === 1) {
                box.innerHTML = "Phase 1: Quiescent Galaxy<br><span style='font-size:0.8em; font-weight:normal'>Gas cooling and settling into disk. Low star formation.</span>";
                box.style.borderLeftColor = "#a54";
                box.style.color = "#fff";
            } else if (phase === 2) { 
                box.innerHTML = "Phase 2: Secular Evolution<br><span style='font-size:0.8em; font-weight:normal'>Spiral arms trigger star formation. Gas migrates inward due to viscosity.</span>";
                box.style.borderLeftColor = "#4facfe";
                box.style.color = "#fff";
            } else if (phase === 3) {
                box.innerHTML = "Phase 3: AGN Ignition (Quasar Mode)<br><span style='font-size:0.8em; font-weight:normal'>Accretion threshold reached. Jets launch. Feedback heats surrounding gas.</span>";
                box.style.borderLeftColor = "#fc0";
                box.style.color = "#fc0";
            } else if (phase === 4) {
                 box.innerHTML = "Phase 4: Quenching (Red & Dead)<br><span style='font-size:0.8em; font-weight:normal'>Fuel exhausted/expelled. Star formation ceases. Galaxy ages to red.</span>";
                 box.style.borderLeftColor = "#555";
                 box.style.color = "#aaa";
            }
        }

        function resetSimulation() {
            agnActive = false;
            agnMass = 0;
            currentPhase = 1;
            agnCore.visible = false;
            time = 0;
            
            // Reset particles
            const positions = galaxyGeo.attributes.position.array;
            const colors = galaxyGeo.attributes.color.array;
            const sizes = galaxyGeo.attributes.size.array;
            const colorGas = new THREE.Color(0x884444);

            for(let i=0; i<NUM_PARTICLES; i++) {
                const r = 5 + Math.random() * DISC_SCALE;
                particlesData[i].r = r;
                particlesData[i].theta = Math.random() * Math.PI * 2;
                particlesData[i].type = TYPE_GAS;
                particlesData[i].age = 0;
                
                positions[i*3] = Math.cos(particlesData[i].theta) * r;
                positions[i*3+1] = particlesData[i].y;
                positions[i*3+2] = Math.sin(particlesData[i].theta) * r;

                colors[i*3] = colorGas.r;
                colors[i*3+1] = colorGas.g;
                colors[i*3+2] = colorGas.b;
                sizes[i] = particlesData[i].baseSize;
            }
            galaxyGeo.attributes.position.needsUpdate = true;
            galaxyGeo.attributes.color.needsUpdate = true;
            
            // Reset Jets
            for(let i=0; i<NUM_JET_PARTICLES; i++) {
                jetData[i].active = false;
                jetGeo.attributes.position.array[i*3+1] = 9999;
            }
            jetGeo.attributes.position.needsUpdate = true;

            updateStatusBox(1);
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = 0.05; // Simulation timestep
            time += dt;

            updateGalaxy(dt);
            updateJets(dt);

            // Camera drift
            camera.position.x += (mouseX * 50 - camera.position.x) * 0.05;
            camera.position.y += (50 + mouseY * 20 - camera.position.y) * 0.05;
            camera.lookAt(0,0,0);

            // Subtle rotation of the whole system for cinematic effect
            // scene.rotation.y = time * 0.005; 

            renderer.render(scene, camera);
        }

        // Start
        init();
        updateStatusBox(1);
        // setTimeout(() => updateStatusBox(2), 2500); // Removed hardcoded transition

    </script>
</body>
</html>
