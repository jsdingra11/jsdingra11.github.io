<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GNDU: The Upside Down</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --stranger-red: #8B0000;
            --upside-down-blue: #0a192f;
            --jumanji-wood: #5D4037;
            --parchment: #F4E4BC;
        }

        body {
            font-family: 'Special Elite', cursive;
            background-color: var(--upside-down-blue);
            color: #fff;
            overflow: hidden;
            transition: background-color 2s ease;
        }

        /* The Core Trick: Map Scrambling */
        #map {
            transition: transform 3s cubic-bezier(0.4, 0, 0.2, 1), filter 2s;
            background: #000;
        }

        .dimension-wrong {
            transform: rotate(180deg) scaleX(-1);
            filter: invert(100%) hue-rotate(180deg) brightness(0.6) contrast(1.5);
        }

        .dimension-realized {
            transform: rotate(0deg) scaleX(1);
            filter: sepia(0.5) contrast(1.1);
        }

        /* UI Styling */
        .vintage-card {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid var(--stranger-red);
            color: white;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .btn-jumanji {
            background: var(--stranger-red);
            color: white;
            font-family: 'Rye', serif;
            box-shadow: 0 4px 0 #4a0000;
        }

        /* GPS Dot - Must always be upright regardless of map rotation */
        .custom-badge-icon {
            transition: transform 0.5s;
        }

        @keyframes flicker {
            0% { opacity: 1; } 5% { opacity: 0.2; } 10% { opacity: 1; }
            15% { opacity: 0.8; } 20% { opacity: 1; } 100% { opacity: 1; }
        }
        .flicker-effect { animation: flicker 0.5s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-black text-[#8B0000] p-3 text-center border-b-2 border-red-900 shadow-lg z-20 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <i class="fas fa-biohazard text-2xl"></i>
            <div>
                <h1 class="text-xl tracking-tighter text-left leading-tight font-bold">HAWKINS LAB: GNDU</h1>
                <p id="dimensionLabel" class="text-[10px] text-red-500 font-sans tracking-[0.3em]">UPSIDE DOWN SIGNAL</p>
            </div>
        </div>
        <button id="logoutBtn" class="hidden text-xs border border-red-500 px-2 py-1 rounded">ABANDON</button>
    </header>

    <main id="app" class="flex-grow relative overflow-hidden flex flex-col">
        
        <div id="loginView" class="absolute inset-0 z-30 flex items-center justify-center p-4 bg-black">
            <div class="vintage-card w-full max-w-md p-8 text-center space-y-6 border-red-600">
                <h2 class="text-3xl font-bold text-red-600 uppercase font-serif">Enter Dimension</h2>
                <div class="flex justify-center gap-4 my-4">
                    <button onclick="setRole('team')" id="roleTeam" class="flex-1 py-2 border-2 border-red-600 bg-red-600 text-white font-bold rounded">SUBJECT</button>
                    <button onclick="setRole('admin')" id="roleAdmin" class="flex-1 py-2 border-2 border-red-600 text-red-600 font-bold rounded">OBSERVER</button>
                </div>

                <form id="authForm" class="space-y-4">
                    <div id="adminFields" class="hidden">
                        <input type="password" id="password" value="qwertyjohn" class="w-full bg-transparent border-b-2 border-red-600 p-2 outline-none text-center">
                    </div>
                    <div id="hunterFields">
                        <input type="text" id="accessCode" placeholder="CODE" maxlength="5" class="w-full text-center text-4xl uppercase bg-transparent border-2 border-red-600 p-2 rounded text-red-500 font-mono">
                    </div>
                    <button type="submit" class="btn-jumanji w-full py-3 text-lg rounded mt-4">SYNC FREQUENCY</button>
                </form>
                <p id="loginError" class="text-red-500 font-bold text-sm hidden"></p>
            </div>
        </div>

        <div id="mainView" class="hidden flex-col h-full relative">
            <div id="map" class="flex-grow w-full z-0 dimension-wrong"></div>

            <div id="teamHud" class="hidden absolute bottom-0 left-0 right-0 z-10 p-4 pointer-events-none">
                <div class="vintage-card p-4 flex flex-col gap-2 pointer-events-auto max-w-lg mx-auto w-full border-red-900">
                    <div class="flex justify-between items-center border-b border-red-900 pb-2">
                        <span id="displayTeamName" class="font-bold text-red-500">Scanning...</span>
                        <div id="statusIndicator" class="px-3 py-1 bg-red-900 text-white text-xs rounded-full">DANGER</div>
                    </div>
                    <div id="locationLabel" class="text-[10px] text-gray-400 uppercase">Current Sector: <span id="currentSectorName" class="text-white">Unknown</span></div>
                    <div id="outOfBoundsAlert" class="hidden bg-red-600 text-white p-2 text-center text-xs font-bold animate-pulse">VOID DETECTED: RETURN TO CAMPUS</div>
                </div>
            </div>

            <div id="adminHud" class="hidden absolute top-0 right-0 bottom-0 w-80 bg-black z-10 border-l-2 border-red-600 shadow-2xl flex flex-col transition-transform translate-x-full md:translate-x-0">
                <div class="bg-red-900 text-white p-3 font-bold text-center">SIGNAL MONITOR</div>
                <div class="p-4 border-b border-red-900">
                    <input type="text" id="newTeamName" placeholder="New Team Name" class="w-full p-2 text-sm bg-gray-900 border border-red-900 rounded mb-2">
                    <button onclick="generateTeam()" class="w-full bg-red-600 text-white p-2 text-xs font-bold rounded">INITIATE SUBJECT</button>
                </div>
                <div id="teamsList" class="flex-grow overflow-y-auto p-2 space-y-2"></div>
            </div>
        </div>
    </main>

    <div id="customModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
        <div class="vintage-card w-full max-w-sm p-6 text-center border-red-600">
            <h3 id="modalTitle" class="text-xl font-bold mb-2 text-red-600">ALERT</h3>
            <p id="modalMessage" class="mb-6 text-sm">Communication Breakdown</p>
            <button onclick="closeModal()" class="btn-jumanji px-6 py-2 rounded">ACKNOWLEDGE</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
            authDomain: "iist-fd6e8.firebaseapp.com",
            projectId: "iist-fd6e8",
            storageBucket: "iist-fd6e8.firebasestorage.app",
            messagingSenderId: "692699808449",
            appId: "1:692699808449:web:120c8941a940d071f24a40"
        };

        const GNDU_BOUNDS = [[31.6295, 74.8225], [31.6315, 74.8300], [31.6390, 74.8320], [31.6445, 74.8225], [31.6440, 74.8180], [31.6315, 74.8190]];
        
        // Stranger Things Story Mapping
        const STORY_LOCS = {
            "GJCEI": { name: "Hawkins Lab", coords: [31.6355, 74.8235], logic: "wrong" },
            "CHEMISTRY": { name: "Experiment Wing", coords: [31.6382, 74.8251], logic: "wrong" },
            "PHYSICS": { name: "The Portal", coords: [31.6395, 74.8240], logic: "correct" },
            "UIT": { name: "Final Exit", coords: [31.6432, 74.8215], logic: "correct" }
        };

        const COLLECTION_TEAMS = "artifacts/gndu-hunt-v1/public/data/gndu_teams";
        let db, currentUserId, currentRole = 'team', map, userMarker, watchId;

        function initApp() {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebase.auth().signInAnonymously();

            if (localStorage.getItem('gndu_team_id')) {
                currentUserId = localStorage.getItem('gndu_team_id');
                showMainView();
            } else {
                showLoginView();
            }
        }

        function showLoginView() {
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('mainView').classList.add('hidden');
        }

        function showMainView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            setTimeout(initMap, 500);
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([31.6370, 74.8220], 16);
            
            // Dark "Upside Down" style tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            if (currentRole === 'team') {
                setupTeamTracking();
                listenToRealityShift();
            } else {
                setupAdminDashboard();
            }
        }

        // SCRAMBLING ENGINE
        function listenToRealityShift() {
            db.doc(`${COLLECTION_TEAMS}/${currentUserId}`).onSnapshot(doc => {
                const data = doc.data();
                const mapEl = document.getElementById('map');
                const label = document.getElementById('dimensionLabel');

                if (data.logicState === 'realized') {
                    mapEl.className = "flex-grow w-full z-0 dimension-realized";
                    label.innerText = "DIMENSION STABILIZED";
                    label.classList.remove('text-red-500');
                    label.classList.add('text-green-500');
                } else {
                    mapEl.className = "flex-grow w-full z-0 dimension-wrong";
                    label.innerText = "UPSIDE DOWN SIGNAL";
                }

                if (data.adminMessage) {
                    showAlert("INCOMING TRANSMISSION", data.adminMessage);
                    db.doc(`${COLLECTION_TEAMS}/${currentUserId}`).update({ adminMessage: "" });
                }
            });
        }

        function setupTeamTracking() {
            document.getElementById('teamHud').classList.remove('hidden');
            document.getElementById('displayTeamName').innerText = localStorage.getItem('gndu_team_name');

            watchId = navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude } = pos.coords;
                
                // Update Local Marker
                if (userMarker) userMarker.setLatLng([latitude, longitude]);
                else userMarker = L.circleMarker([latitude, longitude], { color: 'red', radius: 10 }).addTo(map);
                
                map.panTo([latitude, longitude]);

                // Check Checkpoints
                Object.entries(STORY_LOCS).forEach(([key, loc]) => {
                    const dist = map.distance([latitude, longitude], loc.coords);
                    if (dist < 40) document.getElementById('currentSectorName').innerText = loc.name;
                });

                // Sync to Firebase
                db.doc(`${COLLECTION_TEAMS}/${currentUserId}`).update({
                    lat: latitude, lng: longitude,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
            }, null, { enableHighAccuracy: true });
        }

        // ADMIN CONTROLS
        function setupAdminDashboard() {
            document.getElementById('adminHud').classList.remove('hidden');
            db.collection(COLLECTION_TEAMS).onSnapshot(snap => {
                const list = document.getElementById('teamsList');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = "p-2 border-b border-red-900 text-xs";
                    div.innerHTML = `
                        <div class="font-bold text-red-500">${data.name} [${data.logicState || 'wrong'}]</div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="updateLogic('${doc.id}', 'wrong')" class="bg-red-900 p-1 rounded">CORRUPT</button>
                            <button onclick="updateLogic('${doc.id}', 'realized')" class="bg-green-900 p-1 rounded">REVEAL</button>
                            <button onclick="sendMsg('${doc.id}')" class="bg-blue-900 p-1 rounded">MSG</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.updateLogic = (id, state) => db.doc(`${COLLECTION_TEAMS}/${id}`).update({ logicState: state });
        window.sendMsg = (id) => {
            const m = prompt("Enter cryptic message:");
            if(m) db.doc(`${COLLECTION_TEAMS}/${id}`).update({ adminMessage: m });
        };

        window.setRole = (r) => {
            currentRole = r;
            document.getElementById('adminFields').classList.toggle('hidden', r === 'team');
            document.getElementById('hunterFields').classList.toggle('hidden', r === 'admin');
        };

        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            if (currentRole === 'team') {
                const code = document.getElementById('accessCode').value.toUpperCase();
                const snap = await db.collection(COLLECTION_TEAMS).where('code', '==', code).get();
                if(!snap.empty) {
                    const d = snap.docs[0];
                    localStorage.setItem('gndu_team_id', d.id);
                    localStorage.setItem('gndu_team_name', d.data().name);
                    currentUserId = d.id;
                    showMainView();
                }
            } else if (document.getElementById('password').value === 'qwertyjohn') {
                showMainView();
            }
        };

        async function generateTeam() {
            const name = document.getElementById('newTeamName').value;
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            await db.collection(COLLECTION_TEAMS).add({
                name, code, logicState: 'wrong', status: 'active'
            });
            alert(`Subject Initialized. Code: ${code}`);
        }

        function showAlert(t, m) {
            document.getElementById('modalTitle').innerText = t;
            document.getElementById('modalMessage').innerText = m;
            document.getElementById('customModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('customModal').classList.add('hidden'); }

        window.onload = initApp;
    </script>
</body>
</html>
