<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GNDU: The Upside Down</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --stranger-red: #8B0000; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #000; overflow: hidden; }

        /* The Map must be absolute and fill the background */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1; /* Lowest layer */
            transition: transform 3s ease-in-out, filter 2s;
        }

        /* Logic for Scrambling */
        .dimension-wrong {
            transform: rotate(180deg) scaleX(-1);
            filter: invert(100%) hue-rotate(180deg) brightness(0.6) contrast(1.5);
        }

        .dimension-realized {
            transform: rotate(0deg) scaleX(1);
            filter: sepia(0.5) contrast(1.1);
        }

        /* Overlay UI must be on top of the map */
        header, #loginView, #teamHud, #adminHud { z-index: 50; position: relative; }
        
        .vintage-card {
            background: rgba(10, 10, 10, 0.9);
            border: 2px solid var(--stranger-red);
            backdrop-filter: blur(8px);
            color: white;
        }

        .btn-stranger { background: var(--stranger-red); color: white; font-family: 'Rye', serif; }
    </style>
</head>
<body>

    <header class="bg-black text-red-600 p-3 text-center border-b-2 border-red-900 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="fas fa-biohazard animate-pulse"></i>
            <h1 class="text-lg font-bold uppercase tracking-tighter">Hawkins Lab: GNDU</h1>
        </div>
        <button id="logoutBtn" class="hidden text-[10px] border border-red-600 px-2 py-1 rounded">ABANDON</button>
    </header>

    <main id="app" class="relative h-full w-full">
        <div id="loginView" class="absolute inset-0 flex items-center justify-center p-4 bg-black">
            <div class="vintage-card w-full max-w-md p-8 text-center space-y-6">
                <h2 class="text-2xl font-bold text-red-600">UNAUTHORIZED ACCESS</h2>
                <div class="flex gap-4">
                    <button onclick="setRole('team')" id="roleTeam" class="flex-1 py-2 border-2 border-red-600 bg-red-600 text-white font-bold rounded">SUBJECT</button>
                    <button onclick="setRole('admin')" id="roleAdmin" class="flex-1 py-2 border-2 border-red-600 text-red-600 font-bold rounded">OBSERVER</button>
                </div>
                <form id="authForm" class="space-y-4">
                    <div id="adminFields" class="hidden"><input type="password" id="password" value="qwertyjohn" class="w-full bg-gray-900 border-b-2 border-red-600 p-2 text-center text-white"></div>
                    <div id="hunterFields"><input type="text" id="accessCode" placeholder="RIFT CODE" class="w-full text-center text-2xl bg-transparent border-2 border-red-600 p-2 text-red-500 font-mono"></div>
                    <button type="submit" class="btn-stranger w-full py-3 rounded uppercase font-bold">Initiate Sync</button>
                </form>
            </div>
        </div>

        <div id="mainView" class="hidden h-full w-full">
            <div id="map"></div>

            <div id="teamHud" class="hidden absolute bottom-10 left-0 right-0 p-4 pointer-events-none">
                <div class="vintage-card p-4 max-w-md mx-auto pointer-events-auto">
                    <div class="flex justify-between border-b border-red-900 pb-2 mb-2">
                        <span id="displayTeamName" class="font-bold text-red-500">Scanning...</span>
                        <span class="text-[10px] bg-red-900 px-2 py-1 rounded">RIFT ACTIVE</span>
                    </div>
                    <div class="text-[10px] text-gray-400">SECTOR: <span id="sectorName" class="text-white">UNKNOWN</span></div>
                </div>
            </div>

            <div id="adminHud" class="hidden absolute top-0 right-0 bottom-0 w-64 bg-black/95 border-l-2 border-red-600 flex flex-col translate-x-full md:translate-x-0 transition-transform">
                <div class="p-4 border-b border-red-900">
                    <input type="text" id="newTeamName" placeholder="Subject Name" class="w-full p-2 text-xs bg-gray-900 border border-red-900 text-white mb-2">
                    <button onclick="generateTeam()" class="w-full bg-red-600 text-white py-2 text-[10px] font-bold">INDUCT</button>
                </div>
                <div id="teamsList" class="flex-grow overflow-y-auto p-2"></div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
            authDomain: "iist-fd6e8.firebaseapp.com",
            projectId: "iist-fd6e8",
            storageBucket: "iist-fd6e8.firebasestorage.app",
            messagingSenderId: "692699808449",
            appId: "1:692699808449:web:120c8941a940d071f24a40"
        };

        const COLLECTION_TEAMS = "artifacts/gndu-hunt-v1/public/data/gndu_teams";
        let db, currentUserId, currentRole = 'team', map, userMarker;

        function initApp() {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebase.auth().signInAnonymously();
            if (localStorage.getItem('gndu_team_id')) {
                currentUserId = localStorage.getItem('gndu_team_id');
                showMainView();
            }
        }

        function showMainView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            setTimeout(initMap, 500);
        }

        function initMap() {
            if (map) return;
            // attributionControl: false removes the scrambled letters
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([31.6370, 74.8220], 16);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            if (currentRole === 'team') {
                setupTeamTracking();
                listenToReality();
            } else {
                setupAdmin();
            }
            setTimeout(() => map.invalidateSize(), 200);
        }

        function listenToReality() {
            db.doc(`${COLLECTION_TEAMS}/${currentUserId}`).onSnapshot(doc => {
                const data = doc.data();
                if (!data) return;
                const mapEl = document.getElementById('map');
                mapEl.className = data.logicState === 'realized' ? 'dimension-realized' : 'dimension-wrong';
            });
        }

        function setupTeamTracking() {
            document.getElementById('teamHud').classList.remove('hidden');
            document.getElementById('displayTeamName').innerText = localStorage.getItem('gndu_team_name');
            navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude } = pos.coords;
                if (userMarker) userMarker.setLatLng([latitude, longitude]);
                else userMarker = L.circleMarker([latitude, longitude], { color: 'red', radius: 8 }).addTo(map);
                map.panTo([latitude, longitude]);
                db.doc(`${COLLECTION_TEAMS}/${currentUserId}`).update({ lat: latitude, lng: longitude });
            }, null, { enableHighAccuracy: true });
        }

        function setupAdmin() {
            document.getElementById('adminHud').classList.remove('hidden');
            db.collection(COLLECTION_TEAMS).onSnapshot(snap => {
                const list = document.getElementById('teamsList');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const item = document.createElement('div');
                    item.className = "p-2 border-b border-red-900 text-[10px]";
                    item.innerHTML = `
                        <div class="font-bold text-red-500">${d.name}</div>
                        <div class="flex gap-2 mt-1">
                            <button onclick="updateLogic('${doc.id}', 'wrong')" class="bg-red-900 px-1">CORRUPT</button>
                            <button onclick="updateLogic('${doc.id}', 'realized')" class="bg-green-900 px-1">REVEAL</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        window.updateLogic = (id, s) => db.doc(`${COLLECTION_TEAMS}/${id}`).update({ logicState: s });

        window.setRole = (r) => {
            currentRole = r;
            document.getElementById('adminFields').classList.toggle('hidden', r === 'team');
            document.getElementById('hunterFields').classList.toggle('hidden', r === 'admin');
        };

        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            if (currentRole === 'team') {
                const code = document.getElementById('accessCode').value.toUpperCase();
                const snap = await db.collection(COLLECTION_TEAMS).where('code', '==', code).get();
                if (!snap.empty) {
                    const d = snap.docs[0];
                    localStorage.setItem('gndu_team_id', d.id);
                    localStorage.setItem('gndu_team_name', d.data().name);
                    currentUserId = d.id;
                    showMainView();
                }
            } else if (document.getElementById('password').value === 'qwertyjohn') {
                showMainView();
            }
        };

        async function generateTeam() {
            const name = document.getElementById('newTeamName').value;
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            await db.collection(COLLECTION_TEAMS).add({ name, code, logicState: 'wrong' });
            alert("Code: " + code);
        }

        window.onload = initApp;
    </script>
</body>
</html>
