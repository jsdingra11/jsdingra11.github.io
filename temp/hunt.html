<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stranger Campus: The Upside Down</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@400;700&display=swap');
        
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; }
        .stranger-title { font-family: 'Creepster', cursive; text-shadow: 0 0 10px #ff0000; }
        
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .upside-down-overlay {
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 20%, rgba(30, 0, 0, 0.4) 100%);
            box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.2);
            z-index: 10;
        }

        .ash-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 11;
            background: url('https://www.transparenttextures.com/patterns/dust.png');
            opacity: 0.3;
            animation: drift 20s linear infinite;
        }

        @keyframes drift {
            from { transform: translateY(0); }
            to { transform: translateY(-100px); }
        }

        .glass-panel {
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .status-trapped { color: #ef4444; text-shadow: 0 0 5px #ff0000; }
        .status-realized { color: #10b981; text-shadow: 0 0 5px #00ff00; }

        .custom-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(255,0,0,0.8);
        }
    </style>
</head>
<body class="bg-black text-gray-100">

    <!-- Auth / Role Selection -->
    <div id="auth-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black p-6">
        <h1 class="stranger-title text-6xl text-red-600 mb-8 text-center uppercase tracking-widest">Stranger Campus</h1>
        <div class="glass-panel p-8 rounded-xl w-full max-w-md space-y-4">
            <input id="team-name" type="text" placeholder="Enter Team Name..." class="w-full bg-zinc-900 border border-zinc-700 p-3 rounded focus:outline-none focus:border-red-600">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="login('team')" class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 rounded transition shadow-[0_0_15px_rgba(153,27,27,0.5)]">TEAM</button>
                <button onclick="login('admin')" class="bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-3 rounded transition">ADMIN</button>
            </div>
            <p id="auth-msg" class="text-xs text-center text-zinc-500 italic">Enter the portal at your own risk.</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="hidden h-full flex flex-col relative">
        <!-- UI Overlays -->
        <div id="upside-down-effects" class="hidden">
            <div class="upside-down-overlay"></div>
            <div class="ash-particles"></div>
        </div>

        <!-- Top Status Bar -->
        <header class="absolute top-4 left-4 right-4 z-50 flex justify-between items-start pointer-events-none">
            <div class="glass-panel p-3 rounded-lg pointer-events-auto">
                <h2 id="reality-label" class="stranger-title text-xl text-red-500">UPSIDE DOWN</h2>
                <p id="location-hint" class="text-xs uppercase tracking-tighter opacity-70">Detecting Spores...</p>
            </div>
            <div id="admin-controls" class="hidden pointer-events-auto flex flex-col gap-2">
                <div class="glass-panel p-3 rounded-lg">
                    <h3 class="text-xs font-bold mb-2 text-red-400">ADMIN PANEL</h3>
                    <div class="space-y-2 text-[10px]" id="team-list">
                        <!-- Admin sees team list here -->
                    </div>
                    <button onclick="togglePortals()" class="mt-3 w-full bg-red-900 text-[10px] py-1 rounded">TOGGLE EXIT GATE</button>
                </div>
            </div>
        </header>

        <!-- Bottom Feedback Panel -->
        <footer class="absolute bottom-8 left-4 right-4 z-50 pointer-events-none">
            <div class="glass-panel p-4 rounded-xl pointer-events-auto max-w-lg mx-auto">
                <div class="flex items-center gap-3">
                    <div id="status-icon" class="w-3 h-3 rounded-full bg-red-600 animate-pulse"></div>
                    <p id="game-feedback" class="text-sm font-medium italic">"The clock is ticking, Henderson."</p>
                </div>
                <div id="team-stats" class="mt-2 text-xs grid grid-cols-2 gap-2 opacity-80">
                    <span id="stat-checkpoint">Objective: Unknown</span>
                    <span id="stat-state" class="text-right text-red-500">TRAPPED</span>
                </div>
            </div>
        </footer>

        <!-- The Map -->
        <div id="map"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State
        let map, user, role, currentTeamName;
        let markers = {};
        const CAMPUS_CENTER = [75.9220, 22.7520]; // Default center (Indore UIT area example)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'st-campus-hunt';
        const firebaseConfig = JSON.parse(__firebase_config);
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Thematic Mappings
        const THEME_MAP = {
            "GJCEI": "Hawkins Lab",
            "Chemistry Dept": "Experiment Wing",
            "Physics Dept": "Gate/Portal",
            "Life Science Dept": "Creel House",
            "Library": "Hawkins High",
            "Dean Office": "Dr. Brenner’s Office",
            "Lecture Theatre Complex": "Starcourt Mall",
            "Botanical Garden": "Upside Down (Nature)",
            "Gurudwara": "Safe Haven",
            "Children’s Park": "Kids’ Hideout",
            "UIT": "Exit Gate"
        };

        // UI Setup
        window.login = async (selectedRole) => {
            const name = document.getElementById('team-name').value.trim();
            if (!name) return alert("Please enter a name");
            
            role = selectedRole;
            currentTeamName = name;
            
            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.error(err);
                alert("Login failed.");
            }
        };

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                // Initialize user in DB
                if (role === 'team') {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', user.uid), {
                        name: currentTeamName,
                        role: 'team',
                        state: 'trapped',
                        checkpoint: 0,
                        location: { lat: CAMPUS_CENTER[1], lng: CAMPUS_CENTER[0] },
                        lastActive: Date.now()
                    }, { merge: true });
                }
                
                initApp();
            }
        });

        function initApp() {
            lucide.createIcons();
            initMap();
            setupTracking();
            setupSync();
            
            if (role === 'admin') {
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('reality-label').innerText = "DIMENSION X";
                document.getElementById('reality-label').classList.replace('text-red-500', 'text-blue-500');
            } else {
                document.getElementById('upside-down-effects').classList.remove('hidden');
            }
        }

        function initMap() {
            // Stranger Things Style: Custom colors via paint properties
            map = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    sources: {
                        'osm': {
                            type: 'raster',
                            tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '&copy; OpenStreetMap'
                        },
                        'buildings': {
                            type: 'geojson',
                            data: getMockCampusBuildings()
                        }
                    },
                    layers: [
                        { id: 'osm-layer', type: 'raster', source: 'osm' },
                        {
                            id: 'buildings-3d',
                            type: 'fill-extrusion',
                            source: 'buildings',
                            paint: {
                                'fill-extrusion-color': role === 'team' ? '#4a0000' : '#1e293b',
                                'fill-extrusion-height': ['get', 'height'],
                                'fill-extrusion-base': 0,
                                'fill-extrusion-opacity': 0.8
                            }
                        }
                    ]
                },
                center: CAMPUS_CENTER,
                zoom: 17,
                pitch: 60,
                bearing: role === 'team' ? 180 : 0
            });

            map.on('load', () => {
                // Add Red/Dark Atmosphere if Team
                if (role === 'team') {
                    map.setPaintProperty('buildings-3d', 'fill-extrusion-color', '#3d0000');
                }
            });
        }

        // Coordinate Scrambler: Flips location around the center for the Upside Down
        function transformCoords(lat, lng) {
            if (role === 'admin') return [lng, lat];
            
            // Mirror logic around campus center
            const centerLat = CAMPUS_CENTER[1];
            const centerLng = CAMPUS_CENTER[0];
            
            const newLat = centerLat + (centerLat - lat);
            const newLng = centerLng + (centerLng - lng);
            
            return [newLng, newLat];
        }

        function setupTracking() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    
                    if (role === 'team') {
                        // Real location update to Firebase
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', user.uid), {
                            location: { lat: latitude, lng: longitude },
                            lastActive: Date.now()
                        });

                        // Update local hint based on distance to nearest theme location
                        updateThematicHint(latitude, longitude);
                    }
                }, (err) => console.error("GPS Error", err), {
                    enableHighAccuracy: true,
                    maximumAge: 0
                });
            }
        }

        function setupSync() {
            // Listen to all teams
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'teams');
            onSnapshot(q, (snapshot) => {
                const teamsHtml = [];
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const teamId = docSnap.id;
                    
                    // Transformation logic
                    const mapCoords = transformCoords(data.location.lat, data.location.lng);
                    
                    // Update Markers
                    if (!markers[teamId]) {
                        const el = document.createElement('div');
                        el.className = 'custom-marker';
                        el.style.backgroundColor = (teamId === user.uid) ? '#ef4444' : '#71717a';
                        markers[teamId] = new maplibregl.Marker(el).setLngLat(mapCoords).addTo(map);
                    } else {
                        markers[teamId].setLngLat(mapCoords);
                    }

                    // Admin UI List
                    if (role === 'admin') {
                        teamsHtml.push(`
                            <div class="flex justify-between items-center border-b border-zinc-800 pb-1">
                                <span class="${data.state === 'trapped' ? 'text-red-400' : 'text-green-400'}">${data.name}</span>
                                <button onclick="toggleTeamState('${teamId}', '${data.state}')" class="bg-zinc-700 px-2 rounded">TOGGLE</button>
                            </div>
                        `);
                    }

                    // Local Team UI Update
                    if (teamId === user.uid) {
                        document.getElementById('stat-state').innerText = data.state.toUpperCase();
                        document.getElementById('stat-state').className = `text-right ${data.state === 'trapped' ? 'text-red-500' : 'text-green-500'}`;
                        document.getElementById('game-feedback').innerText = data.state === 'trapped' 
                            ? "You are trapped in the Upside Down. Orient yourself." 
                            : "Reality is stabilizing... find the portal!";
                    }
                });

                if (role === 'admin') {
                    document.getElementById('team-list').innerHTML = teamsHtml.join('') || "No teams active";
                }
            });

            // Global settings listener (portals etc)
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'game', 'global'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.exitActive) {
                        document.getElementById('game-feedback').innerText = "THE EXIT PORTAL IS OPEN AT UIT!";
                    }
                }
            });
        }

        // Admin Actions
        window.toggleTeamState = async (tid, currentState) => {
            const newState = currentState === 'trapped' ? 'realized' : 'trapped';
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', tid), { state: newState });
        };

        window.togglePortals = async () => {
            const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'game', 'global');
            const gSnap = await getDoc(gRef);
            const active = gSnap.exists() ? gSnap.data().exitActive : false;
            await setDoc(gRef, { exitActive: !active }, { merge: true });
        };

        function updateThematicHint(lat, lng) {
            // Simple proximity check for demo
            document.getElementById('location-hint').innerText = "Spores are dense in this sector...";
        }

        // Generate Mock Buildings for the 2.5D visual
        function getMockCampusBuildings() {
            // Simplified building footprints for UIT Campus area
            return {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        properties: { height: 20, name: 'GJCEI' },
                        geometry: { type: 'Polygon', coordinates: [[[75.9215, 22.7525], [75.9220, 22.7525], [75.9220, 22.7520], [75.9215, 22.7520], [75.9215, 22.7525]]] }
                    },
                    {
                        type: 'Feature',
                        properties: { height: 35, name: 'Library' },
                        geometry: { type: 'Polygon', coordinates: [[[75.9225, 22.7535], [75.9230, 22.7535], [75.9230, 22.7530], [75.9225, 22.7530], [75.9225, 22.7535]]] }
                    },
                    {
                        type: 'Feature',
                        properties: { height: 25, name: 'UIT Main' },
                        geometry: { type: 'Polygon', coordinates: [[[75.9205, 22.7510], [75.9215, 22.7510], [75.9215, 22.7505], [75.9205, 22.7505], [75.9205, 22.7510]]] }
                    }
                ]
            };
        }

    </script>
</body>
</html>
