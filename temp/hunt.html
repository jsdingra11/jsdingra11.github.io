<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Upside Down Hunt</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MapLibre GL JS -->
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = JSON.parse(new URLSearchParams(window.location.search).get('firebase_config') || '{}');
        // Fallback for demo environment if config is missing (will rely on injected vars in production)
        const injectedConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const finalConfig = injectedConfig || firebaseConfig;

        const app = initializeApp(finalConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'stranger-things-demo';

        // --- Game Constants & State ---
        let currentUser = null;
        let role = null; // 'ADMIN' or 'TEAM'
        let teamId = null;
        let map = null;
        let userMarker = null;
        let watchId = null;
        let locations = {}; // Will be calculated relative to center
        let gameActive = false;
        
        // Game Logic State
        let isTrapped = true; // True = Upside Down logic (inverted map), False = Real world
        const CENTER_OFFSET_METERS = {
            'PHYSICS': { n: 0, e: 0, label: 'Portal / Physics Dept', type: 'portal' },
            'LAB': { n: 300, e: 200, label: 'Hawkins Lab / GJCEI', type: 'danger' },
            'CHEM': { n: 100, e: -100, label: 'Exp Wing / Chemistry', type: 'clue' },
            'CREEL': { n: -200, e: 150, label: 'Creel House / Life Sci', type: 'danger' },
            'HIGH': { n: 50, e: -300, label: 'Hawkins High / Library', type: 'clue' },
            'BRENNER': { n: 400, e: 50, label: 'Brenner Office / Dean', type: 'boss' },
            'MALL': { n: -100, e: -200, label: 'Starcourt / Lecture Complex', type: 'hub' },
            'NATURE': { n: -500, e: 0, label: 'The Upside Down / Bot Garden', type: 'danger' },
            'HAVEN': { n: 0, e: 400, label: 'Safe Haven / Gurudwara', type: 'save' },
            'HIDEOUT': { n: -100, e: -400, label: 'Hideout / Kids Park', type: 'clue' },
            'EXIT': { n: 600, e: 0, label: 'Exit Gate / UIT', type: 'exit' }
        };

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const gameScreen = document.getElementById('game-screen');
        const adminPanel = document.getElementById('admin-panel');
        const statusMsg = document.getElementById('status-msg');
        const compassNeedle = document.getElementById('compass-needle');
        const overlay = document.getElementById('upside-down-overlay');

        // --- Utils ---
        function getOffsetCoord(lat, lng, northMeters, eastMeters) {
            // Approx: 1 deg lat = 111111m, 1 deg lng = 111111 * cos(lat)
            const r_earth = 6378137;
            const dLat = (northMeters / r_earth) * (180 / Math.PI);
            const dLng = (eastMeters / r_earth) * (180 / Math.PI) / Math.cos(lat * Math.PI / 180);
            return { lat: lat + dLat, lng: lng + dLng };
        }

        // --- Auth & Init ---
        async function init() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInAnonymously(auth); // Prefer anon for this simple game, token logic complex
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    // Check if already registered
                    // In a real app we'd check DB, here we rely on localStorage or session for role
                }
            });
        }

        window.handleLogin = async (selectedRole) => {
            const code = document.getElementById('access-code').value.toUpperCase();
            
            if (selectedRole === 'ADMIN') {
                if (code !== 'HOPPER') {
                    alert('ACCESS DENIED. WRONG CODE.');
                    return;
                }
                role = 'ADMIN';
                teamId = 'admin';
            } else {
                if (!code) {
                    alert('ENTER A TEAM NAME');
                    return;
                }
                role = 'TEAM';
                teamId = code; // Use code as team name
            }

            // Save session
            localStorage.setItem('stranger_role', role);
            localStorage.setItem('stranger_team', teamId);

            loginScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            if (role === 'ADMIN') {
                adminPanel.classList.remove('hidden');
                overlay.style.display = 'none'; // Admin sees reality
            } else {
                // Team starts in Upside Down
                document.body.classList.add('upside-down-mode');
            }

            startGame();
        };

        // --- Core Game Functions ---
        async function startGame() {
            // 1. Get Game Config (Center Point)
            const globalRef = doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'global');
            
            // Listen to Global State
            onSnapshot(globalRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    if (data.center) {
                        initializeLocations(data.center);
                    }
                    if (role === 'TEAM') {
                        // Check if logic state changed for this specific team (stored in team doc, but global override possible)
                        // For simplicity, let's look at a team specific doc
                    }
                } else if (role === 'ADMIN') {
                    // If no center exists, Admin must set it
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const center = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        setDoc(globalRef, { center: center, portal_open: false }, { merge: true });
                    });
                }
            }, (error) => console.error("Snapshot error:", error));

            // Listen to Team State (if Team)
            if (role === 'TEAM') {
                const teamRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', teamId);
                onSnapshot(teamRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        isTrapped = (data.status === 'TRAPPED');
                        updateRealityRender();
                        if (data.message) {
                            showFlashMessage(data.message);
                        }
                    } else {
                        // Init team
                        setDoc(teamRef, { 
                            status: 'TRAPPED', 
                            last_seen: serverTimestamp(),
                            role: 'TEAM'
                        });
                    }
                }, (e) => console.log(e));
            }

            // Listen to All Teams (if Admin)
            if (role === 'ADMIN') {
                const teamsRef = collection(db, 'artifacts', appId, 'public', 'data', 'teams');
                onSnapshot(teamsRef, (snap) => {
                    updateAdminMap(snap.docs.map(d => ({id: d.id, ...d.data()})));
                }, (e) => console.log(e));
            }

            initMap();
        }

        function initializeLocations(center) {
            locations = {};
            Object.keys(CENTER_OFFSET_METERS).forEach(key => {
                const off = CENTER_OFFSET_METERS[key];
                locations[key] = {
                    ...off,
                    coords: getOffsetCoord(center.lat, center.lng, off.n, off.e)
                };
            });
            
            if (map) addLocationMarkers();
        }

        // --- Map Implementation ---
        function initMap() {
            const startPos = { lat: 30.3564, lng: 76.3647 }; // Fallback (Thapar) if no GPS yet

            map = new maplibregl.Map({
                container: 'map',
                style: role === 'ADMIN' 
                    ? 'https://demotiles.maplibre.org/style.json' // Standard for Admin
                    : 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json', // Dark for Team
                center: [startPos.lng, startPos.lat],
                zoom: 17,
                pitch: 60, // 3D Tilt
                bearing: 0,
                attributionControl: false
            });

            // Add 3D Buildings
            map.on('load', () => {
                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': role === 'ADMIN' ? '#aaa' : '#5a0000', // Red buildings for Team
                        'fill-extrusion-height': ['get', 'height'],
                        'fill-extrusion-base': ['get', 'min_height'],
                        'fill-extrusion-opacity': 0.8
                    }
                });
                
                startTracking();
            });
        }

        function startTracking() {
            if (!navigator.geolocation) return;

            watchId = navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude, heading } = pos.coords;
                
                // Update Firebase
                if (currentUser && teamId) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', teamId);
                    updateDoc(docRef, {
                        location: { lat: latitude, lng: longitude },
                        heading: heading || 0,
                        last_seen: serverTimestamp()
                    }).catch(e => {
                        // Silent fail or retry? If doc doesn't exist, created in snapshot listener
                        setDoc(docRef, {
                            location: { lat: latitude, lng: longitude },
                            heading: heading || 0,
                            last_seen: serverTimestamp(),
                            status: 'TRAPPED'
                        }, { merge: true });
                    });
                }

                // Update Map View
                updateUserPosition(latitude, longitude, heading);

            }, (err) => console.error(err), {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });
        }

        let markers = {};

        function updateAdminMap(teams) {
            if (!map) return;
            
            teams.forEach(team => {
                if (!team.location) return;
                
                if (!markers[team.id]) {
                    const el = document.createElement('div');
                    el.className = 'w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg pulse';
                    el.innerHTML = `<span class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs bg-black text-white px-1 rounded whitespace-nowrap">${team.id}</span>`;
                    markers[team.id] = new maplibregl.Marker({ element: el })
                        .setLngLat([team.location.lng, team.location.lat])
                        .addTo(map);
                } else {
                    markers[team.id].setLngLat([team.location.lng, team.location.lat]);
                }
            });
        }

        function updateUserPosition(lat, lng, heading) {
            if (!map) return;

            // 1. Center Map
            map.easeTo({
                center: [lng, lat],
                duration: 1000
            });

            // 2. Handle Rotation (The Mechanic)
            if (role === 'TEAM') {
                if (isTrapped) {
                    // INVERTED REALITY: Map Bearing is South-Up (180).
                    // User heading (device) needs to be reflected visually.
                    map.rotateTo(180, { duration: 1000 });
                    
                    // Update Fake Compass UI
                    // If map is South Up (180), and phone points North (0), MapLibre renders "North" at bottom.
                    // We want user to think "Up" on screen is North.
                    // So we force compass to point Up.
                    compassNeedle.style.transform = `rotate(0deg)`; // Lie to the user
                } else {
                    // REALITY: Map Bearing follows phone heading or North Up
                    // Let's do Standard GPS mode: Bearing follows Heading
                    map.rotateTo(heading || 0, { duration: 1000 });
                    compassNeedle.style.transform = `rotate(-${heading || 0}deg)`; // Real compass
                }
            } else {
                // Admin
                if (!userMarker) {
                    const el = document.createElement('div');
                    el.className = 'w-4 h-4 bg-green-500 rounded-full border-white border-2';
                    userMarker = new maplibregl.Marker({ element: el }).setLngLat([lng, lat]).addTo(map);
                } else {
                    userMarker.setLngLat([lng, lat]);
                }
            }

            // Check distances for cues
            checkProximity(lat, lng);
        }

        function checkProximity(lat, lng) {
            // Simple distance check to locations
            let nearest = null;
            let minDist = Infinity;

            Object.values(locations).forEach(loc => {
                if (!loc.coords) return;
                const d = getDistanceFromLatLonInKm(lat, lng, loc.coords.lat, loc.coords.lng) * 1000;
                if (d < minDist) {
                    minDist = d;
                    nearest = loc;
                }
            });

            if (nearest && minDist < 30) {
                statusMsg.innerHTML = `<span class="text-red-500 animate-pulse">NEAR: ${nearest.label}</span>`;
            } else {
                statusMsg.innerText = role === 'TEAM' ? (isTrapped ? "SEARCHING SIGNAL..." : "CONNECTED TO DIMENSION X") : "MONITORING...";
            }
        }

        function addLocationMarkers() {
            // Remove old markers if any (simple implementation assumes static list)
            Object.values(locations).forEach(loc => {
                const el = document.createElement('div');
                // Icon selection
                let icon = 'üìç';
                if (loc.type === 'portal') icon = 'üåÄ';
                if (loc.type === 'danger') icon = 'ü¶á';
                if (loc.type === 'exit') icon = 'üö™';

                el.innerHTML = `<div class="text-2xl drop-shadow-md filter grayscale hover:grayscale-0 transition-all cursor-pointer" onclick="alert('${loc.label}')">${icon}</div>`;
                
                new maplibregl.Marker({ element: el })
                    .setLngLat([loc.coords.lng, loc.coords.lat])
                    .addTo(map);
            });
        }

        // --- View Updates ---
        function updateRealityRender() {
            if (role !== 'TEAM') return;

            if (isTrapped) {
                document.body.classList.add('upside-down-mode');
                overlay.style.display = 'block';
                map.setStyle('https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json'); // Refresh dark
                map.setPaintProperty('3d-buildings', 'fill-extrusion-color', '#5a0000');
            } else {
                document.body.classList.remove('upside-down-mode');
                overlay.style.display = 'none';
                // Switch to a lighter map or just normal colors
                map.setPaintProperty('3d-buildings', 'fill-extrusion-color', '#444444');
            }
        }

        function showFlashMessage(text) {
            const el = document.createElement('div');
            el.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-90 z-50 pointer-events-none fade-in-out';
            el.innerHTML = `<h1 class="text-4xl text-red-600 font-serif font-bold text-center tracking-widest uppercase glow-text">${text}</h1>`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        // --- Admin Actions ---
        window.toggleTeamState = async () => {
            const targetTeam = prompt("Enter Team Name to Toggle Reality:");
            if (!targetTeam) return;
            
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'teams', targetTeam);
            const snap = await getDoc(ref);
            if (snap.exists()) {
                const currentStatus = snap.data().status;
                await updateDoc(ref, { 
                    status: currentStatus === 'TRAPPED' ? 'REALIZED' : 'TRAPPED',
                    message: currentStatus === 'TRAPPED' ? 'THE MIND FLAYER RETREATS...' : 'WELCOME TO THE UPSIDE DOWN'
                });
            }
        };

        window.sendMessage = async () => {
            const targetTeam = prompt("Enter Team Name (or 'ALL'):");
            const msg = prompt("Enter cryptic message:");
            if (!targetTeam || !msg) return;

            if (targetTeam === 'ALL') {
                // Not efficient for thousands, but fine for campus game
                // skipping for brevity in this file
            } else {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'teams', targetTeam);
                await updateDoc(ref, { message: msg });
            }
        };

        // --- Math Utils ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }

        // Initialize
        init();

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Benguiat+ITC&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --upside-down-red: #ff1100;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #000;
            color: #ccc;
            overflow: hidden; /* Prevent pull-to-refresh */
        }

        .font-stranger {
            font-family: 'Benguiat ITC', serif;
        }

        /* The Upside Down Effect */
        .upside-down-mode #map {
            filter: grayscale(100%) sepia(100%) hue-rotate(320deg) saturate(300%) contrast(1.2);
        }

        .ash-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Snow_falling_at_night.gif/800px-Snow_falling_at_night.gif'); 
            /* Fallback or cheap particle effect */
            background-size: cover;
            opacity: 0.15;
            pointer-events: none;
            mix-blend-mode: screen;
            z-index: 20;
            display: none;
        }
        
        .vignette {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.9) 100%);
            pointer-events: none;
            z-index: 19;
        }

        .glow-text {
            text-shadow: 0 0 10px var(--upside-down-red), 0 0 20px var(--upside-down-red);
        }

        /* Custom Map Markers */
        .marker-team {
            background-color: var(--upside-down-red);
            width: 15px; height: 15px;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--upside-down-red);
        }

        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0px rgba(255, 17, 0, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(255, 17, 0, 0); }
        }

        .compass-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            border: 2px solid #555;
            z-index: 30;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
        }
        .compass-needle {
            width: 4px;
            height: 40px;
            background: linear-gradient(to top, white 50%, red 50%);
            transition: transform 0.5s ease-out;
        }
        
        .fade-in-out {
            animation: fadeInOut 4s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black">
        <h1 class="text-5xl font-stranger text-red-600 mb-8 glow-text text-center px-4">HAWKINS LAB<br>NETWORK</h1>
        
        <div class="w-full max-w-xs space-y-4 px-4">
            <input id="access-code" type="text" placeholder="ENTER ACCESS CODE" 
                   class="w-full bg-gray-900 border-2 border-red-800 text-white p-3 text-center uppercase tracking-widest focus:outline-none focus:border-red-500 rounded">
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="handleLogin('TEAM')" 
                        class="bg-red-900 hover:bg-red-700 text-white py-3 rounded font-bold tracking-wider transition">
                    JOIN HUNT
                </button>
                <button onclick="handleLogin('ADMIN')" 
                        class="bg-gray-800 hover:bg-gray-700 text-gray-400 py-3 rounded font-bold tracking-wider transition border border-gray-600">
                    ADMIN
                </button>
            </div>
        </div>
        <p class="mt-8 text-xs text-gray-600 font-mono">WARNING: UNAUTHORIZED ACCESS IS PROHIBITED</p>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="fixed inset-0 hidden">
        
        <!-- Map Container -->
        <div id="map" class="w-full h-full bg-black"></div>

        <!-- Atmospheric Overlays -->
        <div id="upside-down-overlay" class="ash-overlay"></div>
        <div class="vignette"></div>

        <!-- UI HUD -->
        <div class="absolute top-0 left-0 w-full p-4 z-30 pointer-events-none flex justify-between items-start">
            <div class="bg-black bg-opacity-70 p-2 rounded border-l-2 border-red-600">
                <h2 class="text-xs text-gray-400 uppercase tracking-widest">Signal Status</h2>
                <div id="status-msg" class="text-sm font-bold text-red-500 font-mono mt-1">CONNECTING...</div>
            </div>
        </div>

        <!-- Deceptive Compass -->
        <div class="compass-container">
            <div id="compass-needle" class="compass-needle"></div>
            <div class="absolute -top-1 text-xs font-bold text-gray-400">N</div>
        </div>

        <!-- Footer Objectives -->
        <div class="absolute bottom-6 left-4 right-4 z-30 pointer-events-auto">
            <div class="bg-black bg-opacity-80 p-4 border-t-4 border-red-800 rounded-b shadow-2xl backdrop-blur-sm">
                <h3 class="text-red-600 font-stranger text-lg mb-1">Current Objective</h3>
                <p class="text-gray-300 text-xs leading-relaxed">
                    Readings are erratic. The compass cannot be trusted in the Rift. 
                    <span class="text-white font-bold">Find the Portal (Physics Dept).</span> 
                    Watch your bearings‚Äîup is not always North.
                </p>
            </div>
        </div>

        <!-- Admin Controls (Only visible to Admin) -->
        <div id="admin-panel" class="absolute bottom-32 right-4 z-40 hidden flex flex-col space-y-2 pointer-events-auto">
            <button onclick="toggleTeamState()" class="bg-blue-900 text-white p-3 rounded-full shadow-lg border border-blue-400 hover:bg-blue-700">
                üß† Toggle Logic
            </button>
            <button onclick="sendMessage()" class="bg-green-900 text-white p-3 rounded-full shadow-lg border border-green-400 hover:bg-green-700">
                üí¨ Message
            </button>
        </div>

    </div>

</body>
</html>
