<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jumanji: GNDU Expedition</title>
    
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --jungle-dark: #0a1a0a;
            --jungle-green: #1a4d1a;
            --gold: #deb887; /* Burlywood/Gold */
            --gold-bright: #ffd700;
            --wood-dark: rgba(60, 40, 20, 0.95);
            --danger: #ff4444;
            --paper-tint: sepia(0.6) contrast(1.2) brightness(0.9);
        }

        body { 
            margin: 0; 
            background: #050a05 url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g fill="%23112211" fill-opacity="0.4"><path d="M10 10h20v20h-20z M40 40h20v20h-20z"/></g></svg>'); 
            color: var(--gold); 
            font-family: 'Georgia', 'Times New Roman', serif; 
            overflow: hidden; 
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
        }

        /* --- THE SCRAMBLED GRID --- */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            grid-template-rows: repeat(5, 1fr);
            gap: 4px;
            background: #2b1d0e; /* Wood gap color */
            border: 8px solid #3c2814;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border-radius: 4px;
        }

        .map-tile {
            position: relative;
            background: #1a1510;
            overflow: hidden;
            border: 1px solid #5c4033; 
            transition: transform 0.5s ease;
        }

        /* Jumanji Map Style */
        .leaflet-layer {
            filter: var(--paper-tint);
        }
        
        .leaflet-container {
            background: #1a1510;
        }

        .leaflet-control-container .leaflet-top, 
        .leaflet-control-container .leaflet-bottom { display: none !important; }

        /* --- HUD (Wooden Panel) --- */
        #hud {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: var(--wood-dark);
            border: 2px solid var(--gold);
            border-radius: 8px;
            padding: 20px;
            z-index: 5000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            backdrop-filter: blur(2px);
            text-shadow: 1px 1px 0 #000;
        }

        .hud-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .label { font-size: 11px; color: #aaa; letter-spacing: 2px; text-transform: uppercase; font-family: monospace; }
        .value { font-size: 18px; font-weight: bold; color: var(--gold); }
        .highlight { color: var(--gold-bright); font-size: 20px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        
        /* Danger State for Out of Zone */
        .out-of-zone { border-color: var(--danger) !important; box-shadow: 0 0 20px rgba(255, 50, 50, 0.3) !important; }
        .out-of-zone .highlight { color: var(--danger) !important; text-shadow: 0 0 5px var(--danger) !important; }

        /* Tribal Progress Bar */
        #progress-bar { width: 100%; height: 6px; background: #221100; margin-top: 12px; border: 1px solid #5c4033; border-radius: 3px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #b8860b, #ffd700); transition: width 0.5s ease; }

        /* --- MODALS --- */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; box-sizing: border-box;
        }
        .modal-content { 
            border: 4px double var(--gold); 
            padding: 40px; 
            background: radial-gradient(circle, #2a1a0a, #000); 
            max-width: 400px; 
            border-radius: 10px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.1);
        }
        h1 { color: var(--gold-bright); margin: 0 0 15px 0; font-size: 28px; text-transform: uppercase; letter-spacing: 2px; font-weight: normal; border-bottom: 1px solid var(--gold); padding-bottom: 10px; }
        p { color: #dcb; line-height: 1.6; font-size: 16px; margin-bottom: 25px; }
        button { 
            background: #3c2814; 
            color: var(--gold); 
            border: 1px solid var(--gold); 
            padding: 12px 30px; 
            font-weight: bold; 
            font-size: 14px; 
            cursor: pointer; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            transition: all 0.2s;
            font-family: 'Georgia', serif;
        }
        button:hover { background: var(--gold); color: #1a0a00; box-shadow: 0 0 15px var(--gold); }

        /* --- DEBUG --- */
        #debug-toggle { position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; z-index: 6000; opacity: 0.5; }
        #debug-panel { display: none; position: absolute; top: 50px; right: 10px; background: rgba(0,0,0,0.9); border: 1px solid #555; padding: 10px; width: 200px; z-index: 6000; font-size: 10px; font-family: sans-serif; }
        
        /* --- MARKERS --- */
        /* My Player */
        .user-marker { 
            width: 16px; height: 16px; 
            background: #00ff00; 
            border: 2px solid #fff; 
            border-radius: 50%; 
            box-shadow: 0 0 10px #00ff00; 
            animation: pulse-green 2s infinite; 
        }

        /* Teammate (Other Players) */
        .teammate-marker {
            width: 14px; height: 14px;
            background: #00aaff;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 8px #00aaff;
        }
        .teammate-label {
            position: absolute;
            top: -15px; left: 50%; transform: translateX(-50%);
            color: white; font-size: 10px; font-weight: bold;
            text-shadow: 0 0 2px black;
            white-space: nowrap;
        }

        .target-marker { font-size: 28px; animation: bounce 1.5s infinite ease-in-out; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.8)); }
        
        @keyframes pulse-green { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    </style>
</head>
<body>

    <div id="grid-container"></div>
    
    <div id="hud">
        <div class="hud-row">
            <div>
                <div class="label">Current Objective</div>
                <div class="value highlight" id="target-name">AWAITING...</div>
            </div>
            <div style="text-align: right;">
                <div class="label">Distance</div>
                <div class="value" id="dist-display">---</div>
            </div>
        </div>
        <div class="hud-row">
            <div>
                <div class="label">Team Status</div>
                <div class="value" style="font-size: 14px;" id="gps-status">Connecting...</div>
            </div>
            <div style="text-align: right;">
                <div class="label">Badge Level</div>
                <div class="value" style="font-size: 14px;" id="checkpoint-count">0 / 0</div>
            </div>
        </div>
        <div id="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <h1 id="modal-title">THE GAME BEGINS</h1>
            <p id="modal-msg">Briefing...</p>
            <button onclick="closeModal()">ACCEPT CHALLENGE</button>
        </div>
    </div>

    <div id="debug-toggle" onclick="toggleDebug()">‚öôÔ∏è</div>
    <div id="debug-panel">
        <div style="color:white; margin-bottom:5px;">GAME MASTER</div>
        <button style="padding:5px; font-size:10px; width:100%; margin-top:5px; background:#444; color:white;" onclick="skipLevel()">SKIP LEVEL</button>
        <button style="padding:5px; font-size:10px; width:100%; margin-top:5px; background:#444; color:white;" onclick="toggleScramble()">TOGGLE BOARD SCRAMBLE</button>
        <div id="debug-coords" style="margin-top:5px; color:#0f0; word-break: break-all;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let myUserId = null;
        let unsubscribePlayers = null;
        let otherPlayers = {}; // { uid: { lat, lng, lastUpdate } }

        // --- GAME CONSTANTS ---
        const GNDU_POLYGON = [ 
            [31.631552692516745, 74.83082324628221], 
            [31.641265976684306, 74.82907932842214], 
            [31.64008934348646, 74.81981781333435], 
            [31.630710083556302, 74.82104480288615]
        ];

        const MISSIONS = [
            { name: "Botanical Garden",     lat: 31.6295, lng: 74.8235 }, 
            { name: "The Auditorium",       lat: 31.6370, lng: 74.8300 },
            { name: "Sacred Shrine",        lat: 31.6355, lng: 74.8255 },
            { name: "Dean's Chambers",      lat: 31.6365, lng: 74.8250 },
            { name: "Great Library",        lat: 31.6360, lng: 74.8265 },
            { name: "Alchemist Lab",        lat: 31.6350, lng: 74.8270 },
            { name: "Life Sanctum",         lat: 31.6375, lng: 74.8230 },
            { name: "Physics Tower",        lat: 31.6340, lng: 74.8230 },
            { name: "Lecture Hall C",       lat: 31.6358, lng: 74.8245 },
            { name: "Cipher Dept",          lat: 31.6345, lng: 74.8220 },
            { name: "Crystal Center",       lat: 31.6385, lng: 74.8200 },
            { name: "House of Law",         lat: 31.6380, lng: 74.8195 }, 
            { name: "Merchant Guild",       lat: 31.6390, lng: 74.8190 }, 
            { name: "Playground",           lat: 31.6400, lng: 74.8210 },
            { name: "Tech Citadel",         lat: 31.6405, lng: 74.8195 }
        ];

        // Bounds Calculation
        const lats = GNDU_POLYGON.map(p => p[0]);
        const lngs = GNDU_POLYGON.map(p => p[1]);
        const MAP_BOUNDS = {
            north: Math.max(...lats),
            south: Math.min(...lats),
            east:  Math.max(...lngs),
            west:  Math.min(...lngs)
        };

        const CHECKPOINT_RADIUS_METERS = 35; 
        const GRID_ROWS = 5;
        const GRID_COLS = 5; 

        let currentLevel = 0;
        let mapTiles = [];
        let userPos = { lat: 0, lng: 0 };
        let isGameComplete = false;
        let isScrambled = true; 

        // --- INIT ---
        async function init() {
            // Login Anonymously
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (e) {
                console.error("Auth failed", e);
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    myUserId = user.uid;
                    setupMultiplayerListeners();
                }
            });

            optimizeGridDimensions();
            renderGrid();
            loadMission(0);
            startTracking();
        }

        // --- MULTIPLAYER LOGIC ---
        function setupMultiplayerListeners() {
            if (!myUserId) return;
            const playersRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players');

            // Listen for other players
            unsubscribePlayers = playersRef.onSnapshot((snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (doc.id !== myUserId && data.lat && data.lng) {
                        // Check if data is recent (e.g., last 10 mins)
                        const now = Date.now();
                        if (data.timestamp && (now - data.timestamp < 600000)) {
                            otherPlayers[doc.id] = data;
                        }
                    }
                });
                // Trigger a re-render of markers (handled in loop usually, but force update here for smoothness)
                updateGameLoop(userPos.lat, userPos.lng, true, true);
            }, (error) => {
                console.error("Error listening to players:", error);
            });
        }

        function broadcastLocation(lat, lng) {
            if (!myUserId) return;
            const playersRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players');
            
            playersRef.doc(myUserId).set({
                lat: lat,
                lng: lng,
                timestamp: Date.now(),
                team: 'Explorer'
            }, { merge: true }).catch(e => console.error("Broadcast failed", e));
        }

        // --- GRID SYSTEM ---
        function optimizeGridDimensions() {
            const container = document.getElementById('grid-container');
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;

            const latDiff = MAP_BOUNDS.north - MAP_BOUNDS.south;
            const lngDiff = MAP_BOUNDS.east - MAP_BOUNDS.west;
            const avgLat = (MAP_BOUNDS.north + MAP_BOUNDS.south) / 2;
            
            const metersH = latDiff * 111132;
            const metersW = lngDiff * 111132 * Math.cos(avgLat * Math.PI / 180);
            
            const mapRatio = metersW / metersH;
            const screenRatio = screenW / screenH;

            if (screenRatio > mapRatio) {
                container.style.height = '100vh';
                container.style.width = (screenH * mapRatio) + 'px';
            } else {
                container.style.width = '100vw';
                container.style.height = (screenW / mapRatio) + 'px';
            }
        }

        function toggleScramble() {
            isScrambled = !isScrambled;
            mapTiles.forEach(t => t.map.remove());
            mapTiles = [];
            document.getElementById('grid-container').innerHTML = '';
            renderGrid();
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            const latSpan = MAP_BOUNDS.north - MAP_BOUNDS.south;
            const lngSpan = MAP_BOUNDS.east - MAP_BOUNDS.west;
            const cellH = latSpan / GRID_ROWS;
            const cellW = lngSpan / GRID_COLS;

            let tiles = [];
            const worldBox = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
            
            for (let r = 0; r < GRID_ROWS; r++) {
                for (let c = 0; c < GRID_COLS; c++) {
                    const div = document.createElement('div');
                    div.className = 'map-tile';
                    div.id = `tile-${r}-${c}`;
                    
                    const bN = MAP_BOUNDS.north - (r * cellH);
                    const bS = bN - cellH;
                    const bW = MAP_BOUNDS.west + (c * cellW);
                    const bE = bW + cellW;

                    div.dataset.bounds = JSON.stringify([[bS, bW], [bN, bE]]);
                    tiles.push(div);
                }
            }

            if (isScrambled) {
                for (let i = tiles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
                }
            }

            tiles.forEach(tile => {
                container.appendChild(tile);
                const bounds = JSON.parse(tile.dataset.bounds);
                const latLngBounds = L.latLngBounds(bounds);

                const map = L.map(tile.id, {
                    zoomControl: false,
                    attributionControl: false,
                    dragging: false,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    boxZoom: false,
                    touchZoom: false,
                    zoomSnap: 0,
                    maxBounds: latLngBounds,
                    maxBoundsViscosity: 1.0
                });

                map.fitBounds(latLngBounds, { padding: [0, 0] });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 22,
                    maxNativeZoom: 19,
                    detectRetina: true,
                    opacity: 1
                }).addTo(map);

                // Dark Mask for Jumanji vibe
                L.polygon([worldBox, GNDU_POLYGON], {
                    color: 'transparent',
                    fillColor: '#0a0500', // Dark brown/black mask
                    fillOpacity: 0.9
                }).addTo(map);

                L.polygon(GNDU_POLYGON, {
                    color: '#deb887', // Gold border
                    weight: 3,
                    fill: false,
                    dashArray: '10, 10'
                }).addTo(map);

                mapTiles.push({
                    id: tile.id,
                    map: map,
                    bounds: latLngBounds,
                    userMarker: null,
                    targetMarker: null,
                    teammateMarkers: {} // Map of uid -> markerLayer
                });
            });
        }

        function isPointInPolygon(lat, lng, poly) {
            let x = lat, y = lng;
            let inside = false;
            for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
                let xi = poly[i][0], yi = poly[i][1];
                let xj = poly[j][0], yj = poly[j][1];
                let intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function startTracking() {
            if (!navigator.geolocation) {
                showModal("ERROR", "The compass is broken (GPS Not Supported).");
                return;
            }

            navigator.geolocation.watchPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const acc = pos.coords.accuracy;
                    userPos = { lat, lng };

                    // Broadcast my location to team
                    broadcastLocation(lat, lng);

                    let inZone = isPointInPolygon(lat, lng, GNDU_POLYGON);
                    
                    if (!inZone) {
                        document.getElementById('hud').classList.add('out-of-zone');
                        document.getElementById('gps-status').innerText = "OFF THE BOARD";
                        document.getElementById('gps-status').style.color = "var(--danger)";
                        document.getElementById('target-name').innerText = "RETURN TO MAP";
                    } else {
                        document.getElementById('hud').classList.remove('out-of-zone');
                        // Calculate active teammates
                        const teamCount = Object.keys(otherPlayers).length;
                        document.getElementById('gps-status').innerText = `Team: ${teamCount + 1} Active`;
                        document.getElementById('gps-status').style.color = "var(--gold)";
                        
                        if(document.getElementById('target-name').innerText === "RETURN TO MAP") {
                            document.getElementById('target-name').innerText = MISSIONS[currentLevel].name;
                        }
                    }

                    updateGameLoop(lat, lng, inZone);
                },
                (err) => { document.getElementById('gps-status').innerText = "LOST SIGNAL"; },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

        function updateGameLoop(lat, lng, isSafe, forceUpdate = false) {
            if (isGameComplete && !forceUpdate) return;

            const target = MISSIONS[currentLevel];
            const userLatLng = L.latLng(lat, lng);
            const targetLatLng = L.latLng(target.lat, target.lng);

            // Distance
            const dist = userLatLng.distanceTo(targetLatLng);
            document.getElementById('dist-display').innerText = `${Math.round(dist)}m`;

            // Win Check
            if (isSafe && dist <= CHECKPOINT_RADIUS_METERS && !isGameComplete) {
                levelComplete();
            }

            // Update Markers across all tiles
            mapTiles.forEach((tile) => {
                // 1. My Marker
                if (tile.userMarker) { tile.map.removeLayer(tile.userMarker); tile.userMarker = null; }
                if (tile.bounds.contains(userLatLng)) {
                    const icon = L.divIcon({ className: 'user-marker', iconSize: [16, 16] });
                    tile.userMarker = L.marker([lat, lng], {icon: icon}).addTo(tile.map);
                }

                // 2. Target Marker
                if (tile.targetMarker) { tile.map.removeLayer(tile.targetMarker); tile.targetMarker = null; }
                if (!isGameComplete && tile.bounds.contains(targetLatLng)) {
                    const emoji = currentLevel === MISSIONS.length - 1 ? 'üíé' : 'üìú';
                    const icon = L.divIcon({ 
                        className: 'target-marker', 
                        html: emoji, 
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    });
                    tile.targetMarker = L.marker([target.lat, target.lng], {icon: icon}).addTo(tile.map);
                }

                // 3. Teammate Markers
                // Clean up existing
                Object.values(tile.teammateMarkers).forEach(m => tile.map.removeLayer(m));
                tile.teammateMarkers = {};

                // Add new
                Object.entries(otherPlayers).forEach(([uid, data]) => {
                    const pLat = data.lat;
                    const pLng = data.lng;
                    const pLatLng = L.latLng(pLat, pLng);

                    if (tile.bounds.contains(pLatLng)) {
                        const icon = L.divIcon({
                            className: 'teammate-div',
                            html: `<div class="teammate-marker"></div>`, // Simple blue dot
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        });
                        const marker = L.marker([pLat, pLng], {icon: icon}).addTo(tile.map);
                        tile.teammateMarkers[uid] = marker;
                    }
                });
            });
        }

        function loadMission(index) {
            if (index >= MISSIONS.length) {
                gameWon();
                return;
            }
            const mission = MISSIONS[index];
            document.getElementById('target-name').innerText = mission.name;
            document.getElementById('checkpoint-count').innerText = `${index + 1} / ${MISSIONS.length}`;
            const pct = ((index) / MISSIONS.length) * 100;
            document.getElementById('progress-fill').style.width = `${pct}%`;

            if(index === 0) showModal("JUMANJI", `Welcome to the jungle.<br><br>Find: <b style="color:var(--gold-bright)">${mission.name}</b><br>Stay within the Golden Border.`);
        }

        function levelComplete() {
            if(document.getElementById('modal-overlay').style.display === 'flex') return;
            currentLevel++;
            if (currentLevel >= MISSIONS.length) {
                gameWon();
            } else {
                const nextMission = MISSIONS[currentLevel];
                showModal("DISCOVERED", `The board shifts...<br><br>Next Clue: <b style="color:var(--gold-bright)">${nextMission.name}</b>`);
                loadMission(currentLevel);
            }
        }

        function gameWon() {
            isGameComplete = true;
            document.getElementById('progress-fill').style.width = `100%`;
            showModal("JUMANJI", "You have restored the jewel.<br>The curse is lifted.");
            document.getElementById('target-name').innerText = "CURSE LIFTED";
            document.getElementById('hud').style.borderColor = "var(--gold-bright)";
        }

        function showModal(title, msg) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerHTML = msg;
            document.getElementById('modal-overlay').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function toggleDebug() { const p = document.getElementById('debug-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
        function skipLevel() { levelComplete(); }

        init();
    </script>
</body>
</html>
