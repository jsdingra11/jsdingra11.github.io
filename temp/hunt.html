<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GNDU Jumanji Hunt</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Fonts (Vintage Style) -->
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Special+Elite&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --jumanji-wood: #5D4037;
            --jumanji-green: #2E4C2D;
            --jumanji-gold: #D4AF37;
            --parchment: #F4E4BC;
            --danger: #8B0000;
        }

        body {
            font-family: 'Special Elite', cursive;
            background-color: var(--parchment);
            background-image: 
                radial-gradient(#D7C49E 1px, transparent 1px),
                radial-gradient(#D7C49E 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: #3e2723;
            overflow: hidden; /* App-like feel */
        }

        h1, h2, h3, .brand-font {
            font-family: 'Rye', serif;
        }

        /* Vintage Map Styling */
        .leaflet-layer {
            filter: sepia(0.8) contrast(1.1) brightness(0.9) hue-rotate(-10deg);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #d7c49e; 
        }
        ::-webkit-scrollbar-thumb {
            background: var(--jumanji-wood); 
            border-radius: 4px;
        }

        /* UI Components */
        .vintage-card {
            background: url('https://www.transparenttextures.com/patterns/aged-paper.png'), #fff8e1;
            border: 4px solid var(--jumanji-wood);
            box-shadow: 6px 6px 0px rgba(0,0,0,0.3);
            border-radius: 8px;
            position: relative;
        }

        .vintage-card::before {
            content: '';
            position: absolute;
            top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 2px dashed var(--jumanji-wood);
            pointer-events: none;
        }

        .btn-jumanji {
            background: var(--jumanji-wood);
            color: var(--jumanji-gold);
            border: 2px solid #281814;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Rye', serif;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #281814;
        }

        .btn-jumanji:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #281814;
        }

        .btn-start {
            background: var(--jumanji-green);
        }

        .status-pulse {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(139, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0); }
        }

        /* Leaflet Controls Vintage */
        .leaflet-bar {
            border: 2px solid var(--jumanji-wood) !important;
        }
        .leaflet-bar a {
            background-color: var(--parchment) !important;
            color: var(--jumanji-wood) !important;
        }
        .leaflet-bar a:hover {
            background-color: #eaddcf !important;
            color: #3e2723 !important;
        }

        /* Modal */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-[#2d1b15] text-[#d4af37] p-3 text-center border-b-4 border-[#8b5a2b] shadow-lg z-20 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <i class="fas fa-compass text-2xl animate-spin-slow"></i>
            <div>
                <h1 class="text-xl tracking-widest text-left leading-tight">GNDU HUNT</h1>
                <p class="text-xs text-[#a68b5e] font-sans tracking-wide">JUMANJI EDITION</p>
            </div>
        </div>
        <button id="logoutBtn" class="hidden text-xs border border-[#d4af37] px-2 py-1 rounded hover:bg-[#d4af37] hover:text-[#2d1b15] transition">EXIT GAME</button>
    </header>

    <!-- App Container -->
    <main id="app" class="flex-grow relative overflow-hidden flex flex-col">
        
        <!-- LOGIN SCREEN -->
        <div id="loginView" class="absolute inset-0 z-30 flex items-center justify-center p-4 bg-[url('https://www.transparenttextures.com/patterns/dark-wood.png')]">
            <div class="vintage-card w-full max-w-md p-8 text-center space-y-6">
                <!-- Changed from fa-gem to fa-map-marked-alt -->
                <div class="text-4xl text-[#5D4037] mb-2"><i class="fas fa-map-marked-alt"></i></div>
                <h2 class="text-2xl font-bold text-[#5D4037] uppercase">Enter the Jungle</h2>
                <p class="text-sm">Guru Nanak Dev University</p>
                
                <!-- Role Toggle -->
                <div class="flex justify-center gap-4 my-4">
                    <button onclick="setRole('team')" id="roleTeam" class="flex-1 py-2 border-2 border-[#5D4037] bg-[#5D4037] text-[#D4AF37] font-bold rounded role-btn">HUNTER</button>
                    <button onclick="setRole('admin')" id="roleAdmin" class="flex-1 py-2 border-2 border-[#5D4037] text-[#5D4037] font-bold rounded role-btn">MASTER</button>
                </div>

                <form id="authForm" class="space-y-4">
                    <input type="email" id="email" value="astrodingra@gmail.com" placeholder="Explorer Email" class="w-full bg-transparent border-b-2 border-[#5D4037] p-2 outline-none font-bold placeholder-[#8d6e63]" required>
                    <input type="password" id="password" value="qwertyjohn" placeholder="Secret Code" class="w-full bg-transparent border-b-2 border-[#5D4037] p-2 outline-none font-bold placeholder-[#8d6e63]" required>
                    
                    <div id="teamNameGroup" class="text-left">
                        <label class="text-xs font-bold uppercase">Team Name</label>
                        <input type="text" id="teamName" placeholder="e.g., The Lions" class="w-full bg-[#eaddcf] border border-[#5D4037] p-2 rounded">
                    </div>

                    <button type="submit" class="btn-jumanji w-full py-3 text-lg rounded shadow-lg mt-4">Begin Adventure</button>
                </form>
                
                <!-- Emergency Login -->
                <div class="border-t border-[#5D4037] pt-4 mt-2">
                    <button id="emergencyBtn" class="text-xs text-[#8B0000] underline font-bold hover:text-red-500">
                        ⚠ ISSUES? CLICK FOR EMERGENCY ENTRY
                    </button>
                </div>

                <p id="loginError" class="text-red-700 font-bold text-sm hidden"></p>
            </div>
        </div>

        <!-- MAIN DASHBOARD (Shared Map Area) -->
        <div id="mainView" class="hidden flex-col h-full relative">
            
            <!-- Map Container -->
            <div id="map" class="flex-grow w-full z-0"></div>

            <!-- Overlays -->
            
            <!-- TEAM HUD (Bottom Panel) -->
            <div id="teamHud" class="hidden absolute bottom-0 left-0 right-0 p-4 z-10 bg-gradient-to-t from-[#2d1b15] to-transparent">
                <div class="vintage-card p-4 flex flex-col gap-2">
                    <div class="flex justify-between items-center border-b border-[#5D4037] pb-2">
                        <span id="displayTeamName" class="font-bold text-lg text-[#2E4C2D]">Team Name</span>
                        <div id="statusIndicator" class="px-3 py-1 bg-green-700 text-white text-xs rounded-full shadow font-sans font-bold tracking-wider">SAFE ZONE</div>
                    </div>
                    <div class="flex justify-between items-center text-xs mt-1">
                        <div class="flex flex-col">
                            <span class="text-gray-500">LATITUDE</span>
                            <span id="latDisplay" class="font-mono">--</span>
                        </div>
                        <div class="flex flex-col text-right">
                            <span class="text-gray-500">LONGITUDE</span>
                            <span id="lngDisplay" class="font-mono">--</span>
                        </div>
                    </div>
                    <div id="outOfBoundsAlert" class="hidden bg-[#8B0000] text-[#D4AF37] p-2 text-center text-sm font-bold animate-pulse mt-2 border-2 border-[#D4AF37]">
                        ⚠ WARNING: RETURN TO CAMPUS! ⚠
                    </div>
                </div>
            </div>

            <!-- ADMIN HUD (Side/Bottom Panel) -->
            <div id="adminHud" class="hidden absolute top-0 right-0 bottom-0 w-64 bg-[#f4e4bc] z-10 border-l-4 border-[#5D4037] shadow-2xl transform transition-transform duration-300 translate-x-full md:translate-x-0 overflow-hidden flex flex-col">
                <div class="bg-[#5D4037] text-[#D4AF37] p-3 font-bold text-center">
                    <i class="fas fa-users-cog"></i> HUNTER TRACKER
                </div>
                <div class="p-2 bg-[#d7c49e] text-xs flex justify-between items-center">
                    <span>Teams Active: <span id="teamCount">0</span></span>
                    <button id="refreshMap" class="text-[#5D4037] hover:text-black"><i class="fas fa-sync"></i></button>
                </div>
                <div id="teamsList" class="flex-grow overflow-y-auto p-2 space-y-2">
                    <!-- Team Cards injected here -->
                </div>
            </div>
            
            <!-- Admin Mobile Toggle -->
            <button id="adminToggle" class="hidden absolute top-4 right-4 z-20 bg-[#5D4037] text-[#D4AF37] p-3 rounded-full shadow-lg md:hidden">
                <i class="fas fa-list"></i>
            </button>
        </div>

    </main>

    <!-- Custom Alert Modal -->
    <div id="customModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
        <div class="vintage-card w-full max-w-sm p-6 text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-2 text-[#5D4037]">Notification</h3>
            <p id="modalMessage" class="mb-6 font-sans">Message body</p>
            <button onclick="closeModal()" class="btn-jumanji px-6 py-2 rounded">Dismiss</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
            authDomain: "iist-fd6e8.firebaseapp.com",
            databaseURL: "https://iist-fd6e8-default-rtdb.firebaseio.com",
            projectId: "iist-fd6e8",
            storageBucket: "iist-fd6e8.firebasestorage.app",
            messagingSenderId: "692699808449",
            appId: "1:692699808449:web:120c8941a940d071f24a40"
        };

        // GNDU Boundary (Detailed "Curvy" Polygon)
        // Highly granular coordinates to create a smooth, non-boxy boundary around GNDU
        const GNDU_BOUNDS = [
            // South Boundary (Following GT Road curve)
            [31.6295, 74.8225], // Start Main Gate
            [31.6297, 74.8240],
            [31.6300, 74.8260],
            [31.6305, 74.8285],
            [31.6315, 74.8300],
            
            // South-East Corner (Curving up)
            [31.6325, 74.8308],
            [31.6340, 74.8315],
            
            // East Boundary (Residential Area)
            [31.6360, 74.8320],
            [31.6375, 74.8322],
            [31.6390, 74.8320],
            
            // North-East Curve (Hostels)
            [31.6410, 74.8310],
            [31.6420, 74.8300],
            [31.6430, 74.8285],
            [31.6435, 74.8270],
            
            // North Boundary (Back of Campus)
            [31.6440, 74.8250],
            [31.6445, 74.8225],
            [31.6445, 74.8200],
            [31.6440, 74.8180],
            
            // North-West Curve (Stadium Area)
            [31.6430, 74.8160],
            [31.6415, 74.8150],
            [31.6400, 74.8145],
            
            // West Boundary (Sports/Dept Area)
            [31.6380, 74.8145],
            [31.6360, 74.8148],
            [31.6345, 74.8155],
            
            // South-West Curve (Back to Start)
            [31.6330, 74.8170],
            [31.6315, 74.8190],
            [31.6305, 74.8210]  // Closing loop near start
        ];
        
        // Strict Path for Preview Environment
        const APP_ID = 'gndu-hunt-v1';
        const COLLECTION_TEAMS = `artifacts/${APP_ID}/public/data/gndu_teams`;

        // --- STATE ---
        let currentUser = null;
        let currentRole = 'team'; // 'team' or 'admin'
        let map = null;
        let userMarker = null;
        let watchId = null;
        let allTeamMarkers = {}; // Admin only
        let db = null;
        let auth = null;

        // --- INITIALIZATION ---
        function initApp() {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();

            // Auth State Listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    // Check local storage for role persistence (simple mechanism for demo)
                    const savedRole = localStorage.getItem('gndu_role');
                    if(savedRole) currentRole = savedRole;
                    
                    showMainView();
                } else {
                    showLoginView();
                }
            });

            // Mobile Admin Toggle
            document.getElementById('adminToggle').addEventListener('click', () => {
                const hud = document.getElementById('adminHud');
                hud.classList.toggle('translate-x-full');
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut().then(() => {
                    if(watchId) navigator.geolocation.clearWatch(watchId);
                    localStorage.removeItem('gndu_role');
                    window.location.reload();
                });
            });

            // Emergency Button
            document.getElementById('emergencyBtn').addEventListener('click', (e) => {
                e.preventDefault();
                performEmergencyLogin();
            });
        }

        // --- VIEW MANAGEMENT ---
        function showLoginView() {
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
        }

        function showMainView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('mainView').classList.add('flex');
            document.getElementById('logoutBtn').classList.remove('hidden');

            // Init Map (delay slightly to ensure container has size)
            setTimeout(() => {
                if(!map) initMap();
                
                if (currentRole === 'team') {
                    setupTeamMode();
                } else {
                    setupAdminMode();
                }
            }, 500);
        }

        // --- AUTH LOGIC ---
        function setRole(role) {
            currentRole = role;
            document.querySelectorAll('.role-btn').forEach(b => {
                b.classList.remove('bg-[#5D4037]', 'text-[#D4AF37]');
                b.classList.add('text-[#5D4037]');
            });
            const activeBtn = document.getElementById(role === 'team' ? 'roleTeam' : 'roleAdmin');
            activeBtn.classList.add('bg-[#5D4037]', 'text-[#D4AF37]');
            
            const teamInput = document.getElementById('teamNameGroup');
            if(role === 'admin') teamInput.classList.add('hidden');
            else teamInput.classList.remove('hidden');
        }

        // --- ROBUST AUTH HANDLER ---
        async function performEmergencyLogin() {
            const errorEl = document.getElementById('loginError');
            errorEl.innerText = "Attempting Emergency Access...";
            errorEl.classList.remove('hidden');

            // Generate Random Credentials
            const rand = Math.floor(Math.random() * 100000);
            const tempEmail = `guest${rand}@gndu.hunt`;
            const tempPass = `guestpass${rand}`;
            const teamName = document.getElementById('teamName').value || `Guest Hunter ${rand}`;

            try {
                // Try creating a fresh user
                const cred = await auth.createUserWithEmailAndPassword(tempEmail, tempPass);
                
                // Save context
                localStorage.setItem('gndu_role', currentRole);
                if(currentRole === 'team') {
                    localStorage.setItem('gndu_team_name', teamName);
                    await db.doc(`${COLLECTION_TEAMS}/${cred.user.uid}`).set({
                        name: teamName,
                        status: 'offline',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // If successful, onAuthStateChanged will handle the redirect
            } catch (e) {
                // Last Resort: Anonymous Auth
                try {
                    await auth.signInAnonymously();
                     localStorage.setItem('gndu_role', currentRole);
                    if(currentRole === 'team') localStorage.setItem('gndu_team_name', teamName);
                } catch (anonErr) {
                    errorEl.innerText = "CRITICAL FAIL: " + anonErr.message;
                }
            }
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const teamName = document.getElementById('teamName').value;
            const errorEl = document.getElementById('loginError');

            if (currentRole === 'team' && !teamName) {
                errorEl.innerText = "Team name is required for Hunters.";
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                // Try Normal Login
                await auth.signInWithEmailAndPassword(email, password);
                localStorage.setItem('gndu_role', currentRole);
                if(currentRole === 'team') localStorage.setItem('gndu_team_name', teamName);
            } catch (error) {
                
                // Handle ALL auth failures by trying to register or falling back to temp user
                if (['auth/user-not-found', 'auth/invalid-credential', 'auth/wrong-password'].includes(error.code)) {
                    
                    try {
                        // 1. Try to Register with these credentials (maybe they don't exist yet?)
                        const cred = await auth.createUserWithEmailAndPassword(email, password);
                        localStorage.setItem('gndu_role', currentRole);
                        if(currentRole === 'team') {
                             localStorage.setItem('gndu_team_name', teamName);
                             await db.doc(`${COLLECTION_TEAMS}/${cred.user.uid}`).set({
                                name: teamName,
                                status: 'offline',
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    } catch (regError) {
                        // 2. If Registration fails (Email in use), the password is DEFINITELY wrong and we can't fix it.
                        // Force Emergency Login logic
                        if (regError.code === 'auth/email-already-in-use') {
                           // Auto-trigger emergency login
                           console.log("Credential conflict. Switching to temporary user.");
                           await performEmergencyLogin();
                        } else {
                            errorEl.innerText = regError.message;
                            errorEl.classList.remove('hidden');
                        }
                    }
                } else {
                    errorEl.innerText = error.message;
                    errorEl.classList.remove('hidden');
                }
            }
        });

        // --- MAP LOGIC ---
        function initMap() {
            // Center on GNDU (Updated Center - Shifted West)
            map = L.map('map', {
                zoomControl: true,
                attributionControl: false
            }).setView([31.6370, 74.8220], 15);

            // Vintage Tiles (OpenStreetMap with styling)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            // --- VISUAL ZONES ---
            
            // 1. "Danger Zone" Mask (Red overlay outside campus)
            // Define the whole world as the outer ring
            const worldCoords = [
                [90, -180],
                [90, 180],
                [-90, 180],
                [-90, -180]
            ];
            
            // Draw a polygon that covers the world BUT has a hole where GNDU is
            L.polygon([worldCoords, GNDU_BOUNDS], {
                color: '#8B0000',     // Red Stroke (appears at border of hole)
                weight: 2,
                fillColor: '#8B0000', // Red Fill
                fillOpacity: 0.4,     // Dim the outside world
                stroke: false         // We'll draw the border separately for better control
            }).addTo(map);

            // 2. "Safe Zone" Border (The Campus Boundary)
            const campusPolygon = L.polygon(GNDU_BOUNDS, {
                color: '#2E4C2D',     // Jumanji Green
                weight: 4,
                fillColor: '#00FF00', // Slight green tint inside
                fillOpacity: 0.05,    // Mostly transparent
                dashArray: '10, 10',  // Vintage map feel
                className: 'safe-zone-border'
            }).addTo(map);

            // Fit map to boundary
            map.fitBounds(campusPolygon.getBounds());
            
            // Restrict panning (approximate buffer)
            const bounds = campusPolygon.getBounds();
            const buffer = 0.005; // small buffer
            const maxBounds = [
                [bounds.getSouthWest().lat - buffer, bounds.getSouthWest().lng - buffer],
                [bounds.getNorthEast().lat + buffer, bounds.getNorthEast().lng + buffer]
            ];
            map.setMaxBounds(maxBounds);
        }

        // --- GEOFENCING LOGIC (Point in Polygon) ---
        // Ray-Casting algorithm for arbitrary polygon inclusion
        function isInsideGNDU(lat, lng) {
            let inside = false;
            for (let i = 0, j = GNDU_BOUNDS.length - 1; i < GNDU_BOUNDS.length; j = i++) {
                const xi = GNDU_BOUNDS[i][0], yi = GNDU_BOUNDS[i][1];
                const xj = GNDU_BOUNDS[j][0], yj = GNDU_BOUNDS[j][1];
                
                // Check if ray intersects the polygon edge
                const intersect = ((yi > lng) != (yj > lng)) &&
                    (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);
                
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // --- TEAM MODE LOGIC ---
        function setupTeamMode() {
            document.getElementById('teamHud').classList.remove('hidden');
            const teamName = localStorage.getItem('gndu_team_name') || "Unknown Hunter";
            document.getElementById('displayTeamName').innerText = teamName;

            // Custom Icon
            const hunterIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color:#2E4C2D; width:20px; height:20px; border-radius:50%; border:2px solid #D4AF37; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            if (!navigator.geolocation) {
                showAlert("GPS Error", "Geolocation is not supported by your browser.");
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    // Update HUD
                    document.getElementById('latDisplay').innerText = latitude.toFixed(4);
                    document.getElementById('lngDisplay').innerText = longitude.toFixed(4);

                    // Update Map
                    if (userMarker) {
                        userMarker.setLatLng([latitude, longitude]);
                    } else {
                        userMarker = L.marker([latitude, longitude], { icon: hunterIcon }).addTo(map);
                    }
                    map.panTo([latitude, longitude]);

                    // Geofence Check
                    const isSafe = isInsideGNDU(latitude, longitude);
                    updateTeamStatusUI(isSafe);

                    // Firestore Update (Throttled could be added, doing direct for MVP smoothness)
                    updateLocationInFirestore(latitude, longitude, isSafe ? 'active' : 'out_of_bounds');
                },
                (error) => {
                    showAlert("GPS Error", "Unable to retrieve location. Please enable GPS.");
                    console.error(error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 10000
                }
            );
        }

        function updateTeamStatusUI(isSafe) {
            const indicator = document.getElementById('statusIndicator');
            const alertBox = document.getElementById('outOfBoundsAlert');
            const hud = document.getElementById('teamHud').querySelector('.vintage-card');

            if (isSafe) {
                indicator.innerText = "SAFE ZONE";
                indicator.className = "px-3 py-1 bg-green-700 text-white text-xs rounded-full shadow font-sans font-bold tracking-wider";
                alertBox.classList.add('hidden');
                hud.classList.remove('status-pulse');
            } else {
                indicator.innerText = "DANGER";
                indicator.className = "px-3 py-1 bg-red-700 text-white text-xs rounded-full shadow font-sans font-bold tracking-wider";
                alertBox.classList.remove('hidden');
                hud.classList.add('status-pulse');
                
                // Optional: Vibrate if supported
                if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        }

        async function updateLocationInFirestore(lat, lng, status) {
            if (!currentUser) return;
            try {
                const teamName = localStorage.getItem('gndu_team_name');
                await db.doc(`${COLLECTION_TEAMS}/${currentUser.uid}`).set({
                    name: teamName,
                    lat: lat,
                    lng: lng,
                    status: status,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Sync error", e);
            }
        }

        // --- ADMIN MODE LOGIC ---
        function setupAdminMode() {
            document.getElementById('adminHud').classList.remove('hidden');
            document.getElementById('adminToggle').classList.remove('hidden');

            // Listen to all teams
            db.collection(COLLECTION_TEAMS).onSnapshot((snapshot) => {
                const listEl = document.getElementById('teamsList');
                listEl.innerHTML = ''; // Clear list
                let activeCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const teamId = doc.id;
                    
                    // Filter out stale data (older than 5 mins) if needed, but showing all for now
                    activeCount++;

                    updateAdminMarker(teamId, data);
                    addTeamToList(teamId, data, listEl);
                });
                
                document.getElementById('teamCount').innerText = activeCount;
            });
        }

        function updateAdminMarker(id, data) {
            if (!data.lat || !data.lng) return;

            const isDanger = data.status === 'out_of_bounds';
            const color = isDanger ? '#8B0000' : '#2E4C2D'; // Red or Green

            const iconHtml = `<div style="
                background-color:${color}; 
                width:24px; height:24px; 
                border-radius:50%; 
                border:2px solid #D4AF37; 
                display:flex; justify-content:center; align-items:center;
                color:white; font-size:10px; font-weight:bold;
                box-shadow: 0 0 5px black;">
                ${data.name.charAt(0).toUpperCase()}
            </div>`;

            const icon = L.divIcon({
                className: `marker-${id}`,
                html: iconHtml,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            if (allTeamMarkers[id]) {
                allTeamMarkers[id].setLatLng([data.lat, data.lng]);
                allTeamMarkers[id].setIcon(icon);
            } else {
                const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map);
                marker.bindPopup(`<b>${data.name}</b><br>Status: ${data.status}`);
                allTeamMarkers[id] = marker;
            }
        }

        function addTeamToList(id, data, listEl) {
            const isDanger = data.status === 'out_of_bounds';
            const item = document.createElement('div');
            item.className = `p-2 border-b border-[#5D4037] text-sm flex justify-between items-center ${isDanger ? 'bg-red-100' : ''}`;
            
            // Calc time ago
            let timeStr = "Just now";
            if (data.lastUpdate) {
                const seconds = Math.floor((Date.now() - data.lastUpdate.toDate()) / 1000);
                if (seconds > 60) timeStr = `${Math.floor(seconds/60)}m ago`;
                else timeStr = `${seconds}s ago`;
                
                // Highlight if stale (> 30s)
                if (seconds > 30 && !isDanger) item.style.opacity = "0.6";
            }

            item.innerHTML = `
                <div>
                    <div class="font-bold text-[#5D4037]">${data.name}</div>
                    <div class="text-xs text-gray-600">${timeStr}</div>
                </div>
                <div class="${isDanger ? 'text-red-700 font-bold' : 'text-green-700'} text-xs uppercase">
                    ${isDanger ? 'OUT!' : 'SAFE'}
                </div>
            `;
            
            // Pan to team on click
            item.onclick = () => {
                if(data.lat && data.lng) {
                    map.setView([data.lat, data.lng], 18);
                    if(window.innerWidth < 768) {
                        document.getElementById('adminHud').classList.add('translate-x-full'); // close sidebar on mobile
                    }
                }
            };

            listEl.appendChild(item);
        }

        // --- UTILS ---
        function showAlert(title, message) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerText = message;
            document.getElementById('customModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('customModal').classList.add('hidden');
        }

        // --- START ---
        window.onload = initApp;

    </script>
</body>
</html>
