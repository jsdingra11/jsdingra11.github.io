<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

<title>GNDU Stranger Hunt</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ------------------ FIREBASE ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
  authDomain: "iist-fd6e8.firebaseapp.com",
  projectId: "iist-fd6e8",
  storageBucket: "iist-fd6e8.firebasestorage.app",
  messagingSenderId: "692699808449",
  appId: "1:692699808449:web:120c8941a940d071f24a40"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ------------------ CONSTANTS ------------------ */
const GNDU_CENTER = [74.8255, 31.6370];

const STRANGER_MAP = {
  "Hawkins Lab": "GJCEI",
  "Experiment Wing": "Chemistry Dept",
  "Gate/Portal": "Physics Dept",
  "Creel House": "Life Science Dept",
  "Hawkins High": "Library",
  "Dr. Brenner’s Office": "Dean Office",
  "Starcourt Mall": "Lecture Theatre Complex",
  "Upside Down (Nature)": "Botanical Garden",
  "Safe Haven": "Gurudwara",
  "Kids’ Hideout": "Children’s Park",
  "Exit Gate": "UIT"
};

/* ------------------ MAP HELPERS ------------------ */
function upsideDown([lng, lat]) {
  return [lng * -1, lat * -1];
}

/* ------------------ APP STATE ------------------ */
let map;
let role = "team";
let uid;
let markers = {};

/* ------------------ INIT ------------------ */
onAuthStateChanged(auth, async user => {
  if (!user) return;
  uid = user.uid;

  const userRef = doc(db, "users", uid);
  const snap = await getDoc(userRef);

  role = snap.exists() ? snap.data().role : "team";

  initMap();
  watchGPS();
  if (role === "admin") initAdminListeners();
});

/* ------------------ MAP INIT ------------------ */
function initMap() {
  map = new maplibregl.Map({
    container: 'map',
    style: "https://demotiles.maplibre.org/style.json",
    center: GNDU_CENTER,
    zoom: 16,
    pitch: 60,
    bearing: role === "admin" ? 0 : 180,
    antialias: true
  });

  map.on("load", () => {
    loadBuildings();
  });
}

/* ------------------ 3D BUILDINGS ------------------ */
function loadBuildings() {
  map.addSource("gndu-buildings", {
    type: "geojson",
    data: "/data/gndu_buildings.geojson"
  });

  map.addLayer({
    id: "3d-buildings",
    type: "fill-extrusion",
    source: "gndu-buildings",
    paint: {
      "fill-extrusion-color": "#121212",
      "fill-extrusion-height": ["get", "height"],
      "fill-extrusion-opacity": 0.85
    }
  });
}

/* ------------------ GPS ------------------ */
function watchGPS() {
  navigator.geolocation.watchPosition(pos => {
    const real = [pos.coords.longitude, pos.coords.latitude];
    const display = role === "admin" ? real : upsideDown(real);

    updateMarker(uid, display);

    updateDoc(doc(db, "teams", uid), {
      gps: { lng: real[0], lat: real[1] }
    });
  }, console.error, { enableHighAccuracy: true });
}

/* ------------------ MARKERS ------------------ */
function updateMarker(id, coords) {
  if (!markers[id]) {
    markers[id] = new maplibregl.Marker({ color: role === "admin" ? "lime" : "red" })
      .setLngLat(coords)
      .addTo(map);
  } else {
    markers[id].setLngLat(coords);
  }
}

/* ------------------ ADMIN LISTENERS ------------------ */
function initAdminListeners() {
  onSnapshot(collection(db, "teams"), snap => {
    snap.forEach(docu => {
      const gps = docu.data().gps;
      if (!gps) return;
      updateMarker(docu.id, [gps.lng, gps.lat]);
    });
  });
}

/* ------------------ ADMIN CONTROLS ------------------ */
window.toggleState = async (teamId, state) => {
  await updateDoc(doc(db, "teams", teamId), { state });
};

window.togglePortal = async enabled => {
  await updateDoc(doc(db, "game_state", "global"), {
    portalEnabled: enabled
  });
};

</script>

<style>
body { background:#000; }
#map { height:100vh; width:100vw; }
</style>
</head>

<body>
<div id="map"></div>

<!-- ADMIN PANEL (hidden for teams) -->
<div id="adminPanel" class="fixed bottom-4 left-4 bg-black/80 p-3 rounded text-white hidden">
  <button onclick="togglePortal(true)" class="bg-red-700 px-3 py-1 rounded">Open Portal</button>
</div>

<script>
/* Simple role UI toggle */
setTimeout(() => {
  if (window.role === "admin") {
    document.getElementById("adminPanel").classList.remove("hidden");
  }
}, 3000);
</script>

</body>
</html>
